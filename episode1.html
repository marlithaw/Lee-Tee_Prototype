<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
  <title>Lee & Tee Episode 1: The Recess Battle</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@300;400;500;600;700&family=Fredoka:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="shared/learning-dashboard.css">
  <style>
    :root {
      --bg-primary: #FFF8F0;
      --bg-secondary: #FEF3E2;
      --accent-purple: #7C3AED;
      --accent-amber: #F59E0B;
      --accent-teal: #0D9488;
      --accent-rose: #E11D48;
      --text-primary: #1C1917;
      --text-secondary: #57534E;
      --success: #16A34A;
      --border-light: #E7E5E4;
      --sticky-stack-height: 120px; /* Reduced - only progress bar + nav tabs now */
    }
    
    html {
      /* Do NOT use overflow-x: hidden here - it breaks position: sticky! */
      width: 100%;
      position: relative;
    }

    body {
      font-family: 'Lexend', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.7;
      /* Do NOT use overflow-x: hidden here - it breaks position: sticky! */
      width: 100%;
      max-width: 100vw; /* Prevent horizontal overflow */
      margin: 0;
      padding: 0;
      position: relative;
      touch-action: pan-y pinch-zoom;
    }

    * {
      box-sizing: border-box;
    }

    /* Prevent containers from causing horizontal scroll without breaking sticky */
    section, div:not(#sticky-ui), main, article, header, footer, nav {
      max-width: 100%;
    }

    /* Only hide overflow on main content containers, not global */
    .section-content, main, article {
      overflow-x: auto; /* Allow scroll if needed, don't hide */
      max-width: 100%;
    }

    img, video, iframe {
      max-width: 100% !important;
      height: auto;
    }
    
    body.dyslexia-mode {
      /* Enhanced spacing for dyslexic readers - scientifically proven to help */
      letter-spacing: 0.05em;
      word-spacing: 0.1em;
      line-height: 2;
    }
    
    body.high-contrast {
      --bg-primary: #000000;
      --bg-secondary: #1a1a1a;
      --text-primary: #FFFFFF;
      --text-secondary: #E5E5E5;
      --border-light: #404040;
    }
    
    .font-display { font-family: 'Fredoka', sans-serif; }
    
    /* Animated gradient header */
    .hero-gradient {
      background: linear-gradient(135deg, #7C3AED 0%, #2563EB 50%, #0D9488 100%);
      background-size: 200% 200%;
      animation: gradientShift 8s ease infinite;
    }
    @keyframes gradientShift {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }

    /* Enhanced highlighting styles */
.word-highlight {
    transition: all 0.3s ease;
    padding: 2px 1px;
    border-radius: 2px;
    display: inline;
    position: relative;
}

.word-highlight.active-word {
    background-color: #FDE68A !important;
    color: #000 !important;
    font-weight: 600;
    box-shadow: 0 0 0 2px #F59E0B;
    position: relative;
    z-index: 5;
    animation: wordPulse 0.3s ease;
}

.sentence-highlight.active-sentence {
    background-color: rgba(253, 230, 138, 0.5) !important;
    padding: 8px 12px !important;
    margin: 8px 0 !important;
    border-radius: 4px !important;
    border-left: 3px solid #7C3AED !important;
    border-right: 3px solid #7C3AED !important;
    transition: all 0.3s ease !important;
}

/* For speech bubbles specifically */
.speech-bubble p.sentence-highlight.active-sentence {
    background-color: rgba(253, 230, 138, 0.7) !important;
    border-left: 3px solid #F59E0B !important;
    border-right: 3px solid #F59E0B !important;
}

@keyframes wordPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}
    /* Story section styling */
    .story-text {
      font-size: 1.125rem;
      max-width: 65ch;
    }
    body.dyslexia-mode .story-text {
      font-size: 1.25rem;
      max-width: 55ch;
    }
    
    /* Progress tracking */
    .progress-container {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--border-light);
      z-index: 1000;
    }
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-purple), var(--accent-teal));
      transition: width 0.3s ease;
    }
    
    /* Gamification - Points display */
    .points-display {
      position: fixed;
      top: 20px;
      right: 20px;
      background: white;
      border-radius: 2rem;
      padding: 0.75rem 1.5rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 999;
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .points-number {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--accent-purple);
    }
    .badge-earned {
      animation: badgePop 0.5s ease;
    }
    @keyframes badgePop {
      0% { transform: scale(0) rotate(0deg); }
      50% { transform: scale(1.2) rotate(180deg); }
      100% { transform: scale(1) rotate(360deg); }
    }
    
    /* Celebration overlay */
    .celebration-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1001;
    }
    .celebration-overlay.show {
      display: flex;
      animation: fadeIn 0.3s;
    }
    .celebration-card {
      background: white;
      border-radius: 1rem;
      padding: 2rem;
      text-align: center;
      max-width: 400px;
      animation: slideUp 0.5s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes slideUp {
      from { transform: translateY(50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    /* Confetti effect */
    .confetti {
      position: fixed;
      width: 10px;
      height: 10px;
      background: var(--accent-amber);
      position: absolute;
      animation: confettiFall 3s linear;
    }
    @keyframes confettiFall {
      to { transform: translateY(100vh) rotate(360deg); opacity: 0; }
    }
    
    /* Vocabulary - Predictive style */
    .vocab-predict {
      display: inline-block;
      position: relative;
    }
    .vocab-blank {
      display: inline-block;
      min-width: 100px;
      border-bottom: 2px solid var(--accent-purple);
      padding: 0 0.5rem;
      margin: 0 0.25rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    .vocab-blank:hover {
      background: #F3E8FF;
    }
    .vocab-choices {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      background: white;
      border-radius: 0.5rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      padding: 0.5rem;
      z-index: 10;
      min-width: 150px;
    }
    .vocab-choices.show {
      display: block;
    }
    .vocab-choice-btn {
      display: block;
      width: 100%;
      text-align: left;
      padding: 0.5rem;
      border-radius: 0.25rem;
      border: none;
      background: transparent;
      cursor: pointer;
      transition: background 0.2s;
    }
    .vocab-choice-btn:hover {
      background: #F3E8FF;
    }
    .vocab-choice-btn.correct {
      background: #DCFCE7;
      font-weight: bold;
    }
    .vocab-choice-btn.incorrect {
      background: #FEE2E2;
    }
    
    /* Vocabulary highlight */
    .vocab-word {
      background: linear-gradient(to bottom, transparent 60%, #FDE68A 60%);
      cursor: help;
      font-weight: 500;
      position: relative;
      transition: background 0.2s;
    }
    .vocab-word:hover {
      background: linear-gradient(to bottom, transparent 40%, #FDE68A 40%);
    }
    
    /* ===== ENHANCED READ-ALONG HIGHLIGHTING ===== */
.read-along-container {
  position: relative;
  line-height: 1.8;
}

.word-highlight {
  transition: all 0.3s ease;
  padding: 1px 2px;
  border-radius: 2px;
  display: inline;
  position: relative;
}

.sentence-highlight {
  transition: all 0.3s ease;
  position: relative;
  display: inline;
}

/* Word highlighting (for "Read Aloud" mode) */
.word-highlight.active-word {
  background-color: #FDE68A !important;
  color: #000 !important;
  font-weight: 600;
  box-shadow: 0 0 0 1px #F59E0B;
  z-index: 5;
  animation: wordPulse 0.3s ease;
}

/* Sentence highlighting (for "Listen" mode) */
.sentence-highlight.active-sentence {
  background-color: rgba(253, 230, 138, 0.4) !important;
  padding: 2px 6px;
  border-radius: 4px;
  border-left: 3px solid #7C3AED;
  border-right: 3px solid #7C3AED;
  margin: 0 2px;
}

/* NEW: Direct paragraph highlighting - much simpler! */
p.active-sentence {
  background-color: #FDE68A !important;
  outline: 3px solid #F59E0B !important;
  outline-offset: 2px;
  padding: 8px !important;
  margin: 8px 0 !important;
  transition: all 0.3s ease !important;
  border-radius: 4px;
}

@keyframes wordPulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.03); }
  100% { transform: scale(1); }
}

/* Current word indicator */
.current-word-marker {
  position: absolute;
  width: 6px;
  height: 6px;
  background: #7C3AED;
  border-radius: 50%;
  bottom: -8px;
  left: 50%;
  transform: translateX(-50%);
  animation: markerPulse 1s infinite;
}

@keyframes markerPulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}

/* Button states */
.btn-playing {
  background: #EF4444 !important;
  color: white !important;
}

.btn-listening {
  background: #0D9488 !important;
  color: white !important;
}

/* ===== SIOP SPECIFIC STYLES ===== */
    /* SIOP Strategy Tags - NEW */
    .siop-strategy {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      background: #EFF6FF;
      border: 2px solid #DBEAFE;
      border-radius: 0.5rem;
      font-size: 0.75rem;
      font-weight: 600;
      margin: 0.25rem;
      color: #1E40AF;
    }
    
    /* Language Objectives Box - NEW */
    .language-objective {
      background: linear-gradient(135deg, #DCFCE7 0%, #BBF7D0 100%);
      border-left: 4px solid #16A34A;
      padding: 1rem;
      border-radius: 0.5rem;
      margin: 1rem 0;
    }
    
    /* Content Objectives Box - NEW */
    .content-objective {
      background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
      border-left: 4px solid #D97706;
      padding: 1rem;
      border-radius: 0.5rem;
      margin: 1rem 0;
    }
    
    /* Word Bank for ELL Support - NEW */
    .word-bank {
      background: #F3E8FF;
      border-radius: 0.75rem;
      padding: 1rem;
      margin: 1rem 0;
    }
    
    /* Sentence Frames - NEW */
    .sentence-frame {
      background: #F0F9FF;
      border: 2px dashed #7DD3FC;
      border-radius: 0.5rem;
      padding: 0.75rem;
      margin: 0.5rem 0;
      font-style: italic;
    }
    
    /* Visual Glossary - NEW */
    .visual-glossary-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.75rem;
      background: white;
      border-radius: 0.5rem;
      margin: 0.5rem 0;
    }
    
    /* ===== UDL/SIOP STYLES ===== */
    /* Voice-to-text button styles */
    .speech-btn {
      background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    
    .speech-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
    }
    
    .speech-btn.listening {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    /* Progress tracker styles */
    .progress-check {
      font-size: 16px;
      width: 20px;
      height: 20px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }
    
    .progress-check.completed {
      animation: checkPop 0.3s ease;
    }
    
    @keyframes checkPop {
      0% { transform: scale(0.5); }
      70% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }
    
    /* Vocabulary image container */
    .vocab-image {
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 36px;
      background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%);
      border-radius: 12px;
      margin-right: 16px;
      flex-shrink: 0;
    }
    
    /* Character speech bubbles */
    .speech-bubble {
      position: relative;
      background: white;
      border-radius: 1rem;
      padding: 1rem 1.25rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      margin: 1rem 0;
    }
    .speech-bubble::before {
      content: '';
      position: absolute;
      bottom: -10px;
      left: 24px;
      border-width: 10px;
      border-style: solid;
      border-color: white transparent transparent transparent;
    }
    .speech-bubble.right::before {
      left: auto;
      right: 24px;
    }
    
    /* Character helper buttons */
    .helper-btn {
      position: fixed;
      bottom: 20px;
      z-index: 90;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .helper-btn:hover { transform: scale(1.1); }
    .helper-btn img {
      width: 64px;
      height: 64px;
      border-radius: 50%;
      border: 3px solid white;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      object-fit: cover;
      object-position: top center;
    }
    .helper-btn .label {
      position: absolute;
      bottom: -8px;
      left: 50%;
      transform: translateX(-50%);
      background: white;
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 0.65rem;
      font-weight: 700;
      white-space: nowrap;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    #helper-lee { left: 20px; }
    #helper-tee { left: 100px; }
    
    /* Helper modals */
    .helper-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 150;
      padding: 1rem;
    }
    .helper-modal.open { display: flex; }
    .helper-content {
      background: white;
      border-radius: 1rem;
      padding: 1.5rem;
      max-width: 380px;
      width: 100%;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }
    
    /* Video with caption */
    .video-block {
      position: relative;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 8px 30px -5px rgba(0, 0, 0, 0.2);
      margin: 1.5rem 0;
    }
    .video-block video {
      width: 100%;
      display: block;
    }
    .video-caption {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(transparent, rgba(0,0,0,0.8));
      color: white;
      padding: 2rem 1rem 1rem;
      font-size: 0.875rem;
    }
    
    /* Media containers */
    .media-container {
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 8px 30px -5px rgba(0, 0, 0, 0.15);
      margin: 1.5rem 0;
    }
    .media-container img,
    .media-container video {
      width: 100%;
      display: block;
    }
    .media-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
      margin: 1.5rem 0;
    }
    .media-grid.three-col {
      grid-template-columns: repeat(3, 1fr);
    }
    .media-grid .wide {
      grid-column: span 2;
    }
    
    /* Notebook paper effect */
    .notebook {
      background: 
        repeating-linear-gradient(
          transparent,
          transparent 31px,
          #E5E7EB 31px,
          #E5E7EB 32px
        ),
        linear-gradient(to right, #FEFCE8, #FEFCE8);
      padding: 1.5rem;
      border-radius: 0.5rem;
      box-shadow: 
        inset 0 0 0 1px rgba(0,0,0,0.1),
        4px 4px 0 rgba(0,0,0,0.05);
      position: relative;
    }
    .notebook::before {
      content: '';
      position: absolute;
      left: 2.5rem;
      top: 0;
      bottom: 0;
      width: 2px;
      background: #FCA5A5;
    }
    
    /* Section markers */
    .section-marker {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      background: white;
      border-radius: 2rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      font-weight: 500;
      font-size: 0.875rem;
    }
    
    /* Audio button */
    .audio-btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: var(--accent-teal);
      color: white;
      border-radius: 2rem;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }
    .audio-btn:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(13, 148, 136, 0.3);
    }
    .audio-btn.playing {
      background: var(--accent-rose);
    }
    
    /* Quiz styling */
    .quiz-option {
      padding: 0.75rem 1rem;
      border: 2px solid var(--border-light);
      border-radius: 0.5rem;
      cursor: pointer;
      transition: all 0.2s;
      background: white;
    }
    .quiz-option:hover {
      border-color: var(--accent-purple);
      background: #F3E8FF;
    }
    .quiz-option.selected {
      border-color: var(--accent-purple);
      background: #F3E8FF;
    }
    .quiz-option.correct {
      border-color: var(--success);
      background: #DCFCE7;
    }
    .quiz-option.incorrect {
      border-color: var(--accent-rose);
      background: #FEE2E2;
    }
    
    /* Two-column strategy chart */
    .strategy-column {
      background: white;
      border-radius: 0.75rem;
      overflow: hidden;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    .strategy-column .header {
      padding: 0.75rem 1rem;
      font-weight: 600;
      text-align: center;
    }
    .strategy-column .row {
      padding: 0.75rem 1rem;
      border-top: 1px solid var(--border-light);
      min-height: 60px;
      display: flex;
      align-items: center;
    }
    
    /* Accessibility panel */
    .a11y-panel {
      position: fixed;
      bottom: 20px;
      right: 20px;
      z-index: 100;
    }
    .a11y-btn {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--accent-purple);
      color: white;
      border: none;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(124, 58, 237, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      transition: transform 0.2s;
    }
    .a11y-btn:hover { transform: scale(1.1); }
    .a11y-menu {
      position: absolute;
      bottom: 70px;
      right: 0;
      background: white;
      border-radius: 1rem;
      padding: 1rem;
      box-shadow: 0 10px 40px rgba(0,0,0,0.15);
      min-width: 200px;
      display: none;
    }
    .a11y-menu.open { display: block; }
    .a11y-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--border-light);
    }
    .a11y-toggle:last-child { border-bottom: none; }
    
    /* Toggle switch */
    .toggle {
      width: 44px;
      height: 24px;
      background: #D6D3D1;
      border-radius: 12px;
      position: relative;
      cursor: pointer;
      transition: background 0.2s;
    }
    .toggle.on { background: var(--success); }
    .toggle::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      background: white;
      border-radius: 50%;
      top: 2px;
      left: 2px;
      transition: left 0.2s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .toggle.on::after { left: 22px; }
    
    /* Ritual markers */
    .ritual-marker {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: 2rem;
      font-weight: 600;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .ritual-stir {
      background: #FEF3C7;
      color: #92400E;
    }
    .ritual-bake {
      background: #FCE7F3;
      color: #9D174D;
    }
    .ritual-eat {
      background: #D1FAE5;
      color: #065F46;
    }
    
    /* Vocabulary modal */
    .vocab-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 200;
      padding: 1rem;
    }
    .vocab-modal.open { display: flex; }
    .vocab-card {
      background: white;
      border-radius: 1rem;
      padding: 1.5rem;
      max-width: 400px;
      width: 100%;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }
    
    /* Choice cards for character selection */
    .choice-card {
      border: 3px solid transparent;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
    }
    .choice-card:hover {
      transform: translateY(-4px);
      border-color: var(--accent-purple);
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
    }
    .choice-card.selected {
      border-color: var(--success);
      background: #DCFCE7;
    }
    .choice-card::after {
      content: '‚úì';
      position: absolute;
      top: 10px;
      right: 10px;
      background: var(--success);
      color: white;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: none;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }
    .choice-card.selected::after {
      display: flex;
    }
    
    /* Open-ended response areas */
    .response-area {
      background: white;
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .response-textarea {
      width: 100%;
      min-height: 120px;
      padding: 1rem;
      border: 2px solid var(--border-light);
      border-radius: 0.5rem;
      font-family: inherit;
      font-size: 1rem;
      resize: vertical;
      transition: border-color 0.2s;
    }
    .response-textarea:focus {
      outline: none;
      border-color: var(--accent-purple);
    }
    
    /* Rubric checklist */
    .rubric-item {
      display: flex;
      align-items: flex-start;
      gap: 0.75rem;
      padding: 0.75rem;
      background: white;
      border-radius: 0.5rem;
      margin-bottom: 0.5rem;
      transition: background 0.2s;
    }
    .rubric-item:hover {
      background: #F5F5F4;
    }
    .rubric-checkbox {
      width: 20px;
      height: 20px;
      cursor: pointer;
      accent-color: var(--success);
    }
    .rubric-item.checked {
      background: #DCFCE7;
    }
    
    /* SEL check-in */
    .emotion-option {
      text-align: center;
      padding: 1rem;
      border-radius: 1rem;
      border: 3px solid transparent;
      cursor: pointer;
      transition: all 0.2s;
    }
    .emotion-option:hover {
      border-color: var(--accent-purple);
      transform: scale(1.05);
    }
    .emotion-option.selected {
      border-color: var(--success);
      background: #DCFCE7;
    }
    
    /* Standard tag for explicit standards */
    .standard-tag {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: #EFF6FF;
      border: 1px solid #DBEAFE;
      border-radius: 0.5rem;
      font-size: 0.875rem;
      margin-bottom: 1rem;
    }
    .standard-code {
      font-weight: 600;
      color: #1E40AF;
    }
    
    /* Drag and drop styling */
    .rap-line {
      padding: 0.75rem 1rem;
      margin: 0.5rem 0;
      background: #F5F5F4;
      border-left: 4px solid #D6D3D1;
      border-radius: 0 0.5rem 0.5rem 0;
      cursor: grab;
      transition: all 0.2s;
      user-select: none;
    }
    .rap-line:hover {
      background: #FEF3C7;
      border-left-color: var(--accent-amber);
      transform: translateX(4px);
    }
    .rap-line.dragging {
      opacity: 0.5;
      cursor: grabbing;
    }
    .rap-line.correct {
      background: #DCFCE7;
      border-left-color: var(--success);
    }
    .rap-line.incorrect {
      background: #FEE2E2;
      border-left-color: var(--accent-rose);
      animation: shake 0.3s;
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
    
    .drop-zone {
      min-height: 60px;
      border: 2px dashed #D6D3D1;
      border-radius: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      background: white;
      padding: 0.5rem;
    }
    .drop-zone.drag-over {
      border-color: var(--accent-purple);
      background: #F3E8FF;
    }
    .drop-zone.filled {
      border-style: solid;
      border-color: var(--success);
      background: #DCFCE7;
    }
    
    /* ===== WORD HIGHLIGHTING FOR ORAL ADMINISTRATION ===== */
    .word-highlight {
      transition: all 0.3s ease;
      padding: 2px 1px;
      border-radius: 3px;
      display: inline-block;
      white-space: pre-wrap;
    }
    
    .word-highlight.active {
      background-color: #FDE68A;
      color: #000;
      font-weight: 600;
      box-shadow: 0 0 0 2px #F59E0B;
      position: relative;
      z-index: 5;
    }
    
    .word-highlight.active::after {
      content: '';
      position: absolute;
      bottom: -3px;
      left: 0;
      right: 0;
      height: 2px;
      background: #7C3AED;
      border-radius: 1px;
    }
    
    /* Reading focus mode */
       .reading-focus {
      background: linear-gradient(to right, #FEF3C7 0%, transparent 100%);
      padding: 10px;
      border-radius: 8px;
      margin: 10px 0;
    }
    
        /* ===== STICKY TOP STACK ===== */
    #sticky-ui {
      position: -webkit-sticky; /* Safari support */
      position: sticky;
      top: 0;
      z-index: 1200;
      background: var(--bg-primary, #FFF8F0);
      border-bottom: 1px solid rgba(0, 0, 0, 0.08);
      height: fit-content;
      width: 100%;
      max-width: 100vw; /* Ensure it doesn't overflow viewport */
      overflow: visible;
      isolation: isolate;
      /* Ensure sticky works properly */
      align-self: flex-start;
    }

    /* Neutralize child stickiness so the wrapper controls layout */
    #sticky-ui .section-progress-bar,
    #sticky-ui .section-nav,
    #sticky-ui #global-header {
      position: relative !important;
      top: auto !important;
      z-index: 1 !important;
      left: auto !important;
      right: auto !important;
      /* Ensure children don't have their own sticky/fixed positioning */
      bottom: auto !important;
    }

    /* Learning shell in left sidebar should NOT be sticky */
    #left-rail .learning-shell {
      position: static !important;
      top: auto !important;
      z-index: auto !important;
    }

    #sticky-ui .section-nav {
      padding-right: 8.5rem;
    }

    #sticky-ui .language-toggle {
      position: absolute;
      top: 12px;
      right: 20px;
      z-index: 1250;
      background: white;
      padding: 8px 10px;
      border-radius: 10px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.12);
      display: inline-flex;
      align-items: center;
      gap: 10px;
      border: 1px solid rgba(0, 0, 0, 0.05);
      pointer-events: auto;
    }

    #sticky-ui .language-toggle label {
      font-size: 12px;
      color: #444;
      margin: 0;
    }

    #sticky-ui .language-toggle select {
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid #ddd;
      font-size: 13px;
      background: white;
    }
    
    /* Floating Stop Button (appears during read-aloud) */
    .floating-stop-btn {
      position: fixed;
      bottom: 80px;
      right: 20px;
      z-index: 200;
      background: #DC2626;
      color: white;
      padding: 14px 20px;
      border-radius: 50px;
      font-weight: bold;
      font-size: 16px;
      box-shadow: 0 8px 24px rgba(220, 38, 38, 0.4);
      cursor: pointer;
      display: none;
      animation: pulse 2s infinite;
      border: 3px solid white;
    }

    .floating-stop-btn.active {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    /* Mobile responsiveness */
    @media (max-width: 768px) {
      /* Prevent horizontal scroll on mobile WITHOUT breaking sticky */
      html, body {
        /* Do NOT use overflow-x: hidden - breaks position: sticky! */
        width: 100% !important;
        max-width: 100vw !important;
      }

      /* Ensure all sections stay within viewport */
      section:not(#sticky-ui), div:not(#sticky-ui), main, article {
        max-width: 100vw !important;
      }

      /* Only specific content containers can have overflow hidden */
      .section-content, main > *, article > * {
        max-width: 100% !important;
        overflow-x: auto; /* Allow scroll if needed */
      }

      /* Constrain flex and grid containers */
      .flex, .grid {
        max-width: 100% !important;
      }

      .points-display {
        top: 10px;
        right: 10px;
        padding: 0.5rem 1rem;
      }
            .points-number {
        font-size: 1.25rem;
      }

      #sticky-ui .section-nav {
        padding-right: 7rem;
      }

      #sticky-ui .language-toggle {
        top: 10px;
        right: 12px;
        gap: 8px;
        padding: 7px 9px;
      }
      .helper-btn {
        bottom: 10px;
      }
      #helper-lee { left: 10px; }
      #helper-tee { left: 80px; }
      
      /* Hide progress tracker on mobile */
      .fixed.left-4.top-1\/4 {
        display: none;
      }
      
      /* Voice buttons full width on mobile */
      .mt-2.flex.gap-2 {
        flex-direction: column;
      }
      
      .mt-2.flex.gap-2 button {
        width: 100%;
      }
      
      .floating-stop-btn {
        bottom: 100px;
        right: 50%;
        transform: translateX(50%);
        font-size: 16px;
        padding: 14px 20px;
      }
      
      .vocab-image {
        width: 50px;
        height: 50px;
        font-size: 28px;
        margin-right: 12px;
      }
      
      .speech-btn {
        padding: 6px 12px;
        font-size: 13px;
      }
    }
    
   
    /* Image error fallback */
    img {
      background: linear-gradient(135deg, #f3e8ff 0%, #fef3c7 100%);
    }
    
    /* Smooth scroll for sections */
    html { scroll-behavior: smooth; }
    
  /* Print styles */
    @media print {
      .a11y-panel, .progress-container, .audio-btn, .helper-btn, .points-display { display: none; }
      body { background: white; }
    }

    /* Lesson navigation bar */
    #lesson-nav {
      position: sticky;
      top: 84px;
      z-index: 850;
      background: #ffffff;
      border: 1px solid var(--border-light);
      box-shadow: 0 10px 30px -18px rgba(0, 0, 0, 0.35);
      margin: 0 1.5rem 1rem;
      border-radius: 999px;
      padding: 0.75rem 1rem;
    }

    #lesson-nav .lesson-nav__links {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      align-items: center;
      justify-content: center;
    }

    #lesson-nav a {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.55rem 0.9rem;
      border-radius: 999px;
      text-decoration: none;
      font-weight: 700;
      color: #4b5563;
      background: #f8fafc;
      border: 1px solid #e5e7eb;
      transition: all 0.2s ease;
    }

    #lesson-nav a:hover, #lesson-nav a:focus {
      background: #eef2ff;
      color: #312e81;
      border-color: #c7d2fe;
      outline: none;
      box-shadow: 0 6px 16px -10px rgba(49, 46, 129, 0.4);
    }
    #lesson-nav a:focus-visible {‚êä
      box-shadow: 0 0 0 3px rgba(49, 46, 129, 0.4);‚êä
    }‚êä
‚êä
    .anchor-target {‚êä
      scroll-margin-top: var(--sticky-stack-height);
      display: block;‚êä
      height: 1px;‚êä
      width: 1px;‚êä
      position: relative;‚êä
      top: -1px;‚êä

    }

    @media (max-width: 768px) {
      #lesson-nav {
        margin: 0 0 1rem;
        border-radius: 1rem;
        overflow-x: auto;
        top: 0;
      }
      #lesson-nav .lesson-nav__links {
        justify-content: flex-start;
        flex-wrap: nowrap;
      }
            #lesson-nav a {
        white-space: nowrap;
      }
    }
    
    /* Left Rail Sidebar */
    .left-rail {
      position: fixed;
      left: 0;
      top: 80px;
      width: 280px;
      height: calc(100vh - 80px);
      background: white;
      border-right: 2px solid var(--border-light);
      overflow-y: auto;
      padding: 1.5rem;
      z-index: 30;
      transition: transform 0.3s ease;
    }

    .left-rail.mobile-hidden {
      transform: translateX(-100%);
    }

    .main-with-rail {
      margin-left: 280px;
      padding-top: 80px;
    }

    @media (max-width: 1024px) {
      .left-rail {
        transform: translateX(-100%);
      }

      .left-rail.mobile-open {
        transform: translateX(0);
      }

      .main-with-rail {
        margin-left: 0;
      }
    }

    .help-box {
      border-left: 4px solid currentColor;
      transition: all 0.3s ease;
    }
  </style>

 <!-- Load Shared Components -->
  <script src="shared-header.js"></script>
  <script src="shared-skills.js"></script>
  <script src="shared/shared/learning-dashboard.js"></script>

  <!-- Load Option 3: Progressive Navigation & Translation System -->
  <link rel="stylesheet" href="shared/progressive-nav.css">
  <script src="translations/translation-engine.js"></script>
  <script src="shared/progressive-nav.js"></script>
  <script src="shared/adaptive-helpers.js"></script>

  <style>
    /* Mobile-specific sticky stack sizing */
    @media (max-width: 768px) {
      :root {
        --sticky-stack-height: 140px; /* Smaller - dashboard moved to sidebar */
      }
    }
  </style>
</head>
<body data-episode="1">
  <div id="sticky-ui">
    <!-- Progressive Navigation: Progress Bar + Section Nav -->
    <div id="section-progress-bar" class="section-progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
      <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
    </div>

    <nav id="section-nav" class="section-nav" aria-label="Section navigation">
      <!-- Will be populated by JavaScript -->
    </nav>

    <!-- Global Header -->
    <div id="global-header"></div>
  </div>

  <style>
  /* Make section switching VERY obvious for testing */
  .section-content[data-section="1"] {
    border: 5px solid #7C3AED !important;
    background: linear-gradient(to bottom, #F3E8FF, #FFFFFF) !important;
    padding: 2rem !important;
    min-height: 400px !important;
  }
  .section-content[data-section="2"] {
    border: 5px solid #F59E0B !important;
    background: linear-gradient(to bottom, #FEF3C7, #FFFFFF) !important;
    padding: 2rem !important;
    min-height: 400px !important;
  }
  .section-content[data-section="3"] {
    border: 5px solid #0D9488 !important;
    background: linear-gradient(to bottom, #CCFBF1, #FFFFFF) !important;
    padding: 2rem !important;
    min-height: 400px !important;
  }
  .section-content[data-section="4"] {
    border: 5px solid #EC4899 !important;
    background: linear-gradient(to bottom, #FCE7F3, #FFFFFF) !important;
    padding: 2rem !important;
    min-height: 400px !important;
  }
  .section-content[data-section="5"] {
    border: 5px solid #2563EB !important;
    background: linear-gradient(to bottom, #DBEAFE, #FFFFFF) !important;
    padding: 2rem !important;
    min-height: 400px !important;
  }
  .section-content[data-section="6"] {
    border: 5px solid #16A34A !important;
    background: linear-gradient(to bottom, #DCFCE7, #FFFFFF) !important;
    padding: 2rem !important;
    min-height: 400px !important;
  }
  .section-content[data-section="7"] {
    border: 5px solid #EF4444 !important;
    background: linear-gradient(to bottom, #FEE2E2, #FFFFFF) !important;
    padding: 2rem !important;
    min-height: 400px !important;
  }
  .section-content {
    margin: 2rem auto !important;
    max-width: 1200px !important;
  }
  </style>

  <div id="top" class="anchor-target" aria-hidden="true"></div>

  <!-- Mobile Rail Toggle -->
  <button onclick="toggleLeftRail()"
          class="lg:hidden fixed bottom-6 left-6 z-40 w-14 h-14 bg-purple-600 text-white rounded-full shadow-lg flex items-center justify-center">
    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
    </svg>
  </button>

  <!-- Left Rail Sidebar -->
  <aside id="left-rail" class="left-rail mobile-hidden">
    <!-- Unified Learning Dashboard Shell -->
    <div id="learningShell" class="learning-shell" style="position: static; border: none; box-shadow: none; padding: 1rem 0; margin-bottom: 1.5rem;">
      <button id="learningShellToggle" class="learning-shell__mobile-toggle" aria-expanded="false">
        üìö Learning Dashboard
      </button>
      <div class="learning-shell__row" style="grid-template-columns: 1fr; gap: 1rem;">
        <div class="learning-shell__section">
          <span class="learning-shell__pill">Book 1 Journey</span>
          <div class="learning-shell__meta-title">Same Structure. Different Stuff.</div>
          <div class="learning-shell__meta-subtitle">Stay aware of goals and wins across episodes.</div>
          <div class="learning-shell__label-row">
            <span id="learningShellBookLabel">Book 1: 0/4 Episodes</span>
            <span id="learningShellBookPercent">0%</span>
          </div>
          <div class="learning-shell__progress" aria-hidden="true">
            <div id="learningShellBookFill" class="learning-shell__progress-fill"></div>
          </div>
        </div>

        <div class="learning-shell__section learning-shell__episode">
          <div class="learning-shell__label-row">
            <span class="learning-shell__meta-title" id="learningShellEpisodeTitle">Episode 1</span>
            <span class="learning-shell__meta-subtitle" id="learningShellEpisodeLabel">0/21 sections</span>
          </div>
          <div class="learning-shell__progress" aria-hidden="true">
            <div id="learningShellEpisodeFill" class="learning-shell__progress-fill"></div>
          </div>
        </div>

        <div class="learning-shell__section">
          <div class="learning-shell__label-row">
            <span class="learning-shell__meta-title">Recent Badges</span>
            <span class="learning-shell__meta-subtitle">Motivation at a glance</span>
          </div>
          <div id="learningShellBadges" class="learning-shell__badge-row" aria-live="polite"></div>
        </div>

        <div class="learning-shell__section" style="align-items: flex-end;">
          <a id="learningShellContinue" class="learning-shell__cta" href="#">
            ‚ñ∂ Continue
          </a>
        </div>
      </div>
    </div>

    <div class="mb-6">
      <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
        <span class="text-xl">‚úì</span>
        Lesson Progress
      </h3>
      <div id="progress-checklist" class="space-y-2 text-sm"></div>
    </div>

    <div class="mb-6">
      <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
        <span class="text-xl">üîó</span>
        Quick Jump
      </h3>
      <div class="space-y-2 text-sm">
        <a href="#vocab" class="block px-3 py-2 rounded-lg hover:bg-gray-100 text-gray-700">üìö Vocabulary</a>
        <a href="#story" class="block px-3 py-2 rounded-lg hover:bg-gray-100 text-gray-700">üìñ Story</a>
        <a href="#practice" class="block px-3 py-2 rounded-lg hover:bg-gray-100 text-gray-700">‚úçÔ∏è Practice</a>
        <a href="#check" class="block px-3 py-2 rounded-lg hover:bg-gray-100 text-gray-700">‚úÖ Check</a>
        <a href="#reflect" class="block px-3 py-2 rounded-lg hover:bg-gray-100 text-gray-700">üí≠ Reflect</a>
      </div>
    </div>

    <div>
      <button onclick="resetEpisodeProgress()"
              class="w-full px-4 py-2 bg-gray-200 hover:bg-gray-300 rounded-lg text-sm text-gray-700 transition-colors">
        üîÑ Reset Progress
      </button>
    </div>
  </aside>

  <!-- FLOATING STOP BUTTON (Mobile Read-Aloud Control) -->
  <button id="floatingStopBtn" class="floating-stop-btn" onclick="stopAllNarration()">
    <span>‚èπÔ∏è</span>
    <span>STOP</span>
  </button>

  <!-- CELEBRATION OVERLAY -->
  <div id="celebrationOverlay" class="celebration-overlay">
    <div class="celebration-card">
      <div class="text-6xl mb-4" id="celebrationEmoji">üéâ</div>
      <h3 class="font-display text-2xl font-bold mb-2" id="celebrationTitle">Great Job!</h3>
      <p class="text-gray-600 mb-4" id="celebrationMessage">You earned points!</p>
      <button onclick="closeCelebration()" class="bg-purple-600 text-white px-6 py-2 rounded-full font-bold hover:bg-purple-700">
        Continue Learning
      </button>
    </div>
  </div>

  <!-- Character Helper Buttons -->
  <div id="helper-lee" class="helper-btn" onclick="openHelper('lee')">
    <img src="Gemini_Generated_Image_8qgtlc8qgtlc8qgt.png" alt="Lee with notebook">
    <div class="label text-purple-600">ASK LEE</div>
  </div>
  
  <div id="helper-tee" class="helper-btn" onclick="openHelper('tee')">
    <img src="Gemini_Generated_Image_bvzywpbvzywpbvzy.png" alt="Tee gesturing">
    <div class="label text-amber-600">ASK TEE</div>
  </div>

  <!-- Contextual Helper Popup -->
  <div id="contextHelper" class="fixed bottom-24 right-6 hidden z-50 animate-bounce">
    <div class="bg-white rounded-xl shadow-2xl p-4 max-w-xs border-4 border-purple-500">
      <div class="flex items-start gap-3">
        <img id="contextHelperAvatar" src="" alt="" class="w-12 h-12 rounded-full">
        <div>
          <p class="font-bold text-purple-700 mb-1" id="contextHelperName"></p>
          <p class="text-sm" id="contextHelperMessage"></p>
        </div>
      </div>
      <div class="flex gap-2 mt-3">
        <button onclick="showContextHelp()" class="flex-1 bg-purple-600 text-white px-3 py-2 rounded-lg text-sm font-bold hover:bg-purple-700">
          Show Me How
        </button>
        <button onclick="dismissContextHelper()" class="px-3 py-2 bg-gray-200 rounded-lg text-sm">
          Not Now
        </button>
      </div>
    </div>
  </div>

  <!-- Lee Helper Modal -->
  <div id="lee-modal" class="helper-modal" onclick="closeHelper(event, 'lee')">
    <div class="helper-content border-l-8 border-purple-500" onclick="event.stopPropagation()">
      <div class="flex items-center gap-3 mb-4">
        <img src="Gemini_Generated_Image_8qgtlc8qgtlc8qgt.png" alt="Lee" class="w-12 h-12 rounded-full object-cover object-top">
        <h3 class="font-display text-xl font-bold">Lee's Writing Tips</h3>
      </div>
      <p class="mb-4 text-gray-600">Stuck on your writing? Try these sentence starters:</p>
      <ul class="space-y-2 text-gray-700">
        <li class="flex items-start gap-2">
          <span class="text-purple-500">üìù</span>
          <span>"Even though some people think..."</span>
        </li>
        <li class="flex items-start gap-2">
          <span class="text-purple-500">üìù</span>
          <span>"The evidence actually shows..."</span>
        </li>
        <li class="flex items-start gap-2">
          <span class="text-purple-500">üìù</span>
          <span>"They claimed X, but they forgot Y."</span>
        </li>
        <li class="flex items-start gap-2">
          <span class="text-purple-500">üìù</span>
          <span>"This matters because..."</span>
        </li>
      </ul>
      <p class="mt-4 text-xs text-gray-400 text-center">(Click outside to close)</p>
    </div>
  </div>

  <!-- Tee Helper Modal -->
  <div id="tee-modal" class="helper-modal" onclick="closeHelper(event, 'tee')">
    <div class="helper-content border-l-8 border-amber-500" onclick="event.stopPropagation()">
      <div class="flex items-center gap-3 mb-4">
        <img src="Gemini_Generated_Image_bvzywpbvzywpbvzy.png" alt="Tee" class="w-12 h-12 rounded-full object-cover object-top">
        <h3 class="font-display text-xl font-bold">Tee's Strategy Check</h3>
      </div>
      <p class="mb-4 text-gray-600">Don't just be loud. Be right. Ask yourself:</p>
      <ol class="space-y-3 text-gray-700">
        <li class="flex items-start gap-3">
          <span class="bg-amber-100 text-amber-800 w-6 h-6 rounded-full flex items-center justify-center font-bold text-sm">1</span>
          <span>Did you repeat their claim back?</span>
        </li>
        <li class="flex items-start gap-3">
          <span class="bg-amber-100 text-amber-800 w-6 h-6 rounded-full flex items-center justify-center font-bold text-sm">2</span>
          <span>Did you ask for the receipts?</span>
        </li>
        <li class="flex items-start gap-3">
          <span class="bg-amber-100 text-amber-800 w-6 h-6 rounded-full flex items-center justify-center font-bold text-sm">3</span>
          <span>Do you have YOUR own facts?</span>
        </li>
        <li class="flex items-start gap-3">
          <span class="bg-amber-100 text-amber-800 w-6 h-6 rounded-full flex items-center justify-center font-bold text-sm">4</span>
          <span>Did you land the punchline?</span>
        </li>
      </ol>
      <p class="mt-4 text-xs text-gray-400 text-center">(Click outside to close)</p>
    </div>
  </div>

    <!-- Vocabulary Modal -->
  <div id="vocabModal" class="vocab-modal" onclick="closeVocabModal(event)">
    <div class="vocab-card" onclick="event.stopPropagation()">
      <div class="flex items-start gap-4 mb-3">
        <div class="text-4xl" id="vocabImage">üìö</div>
        <div class="flex-1">
          <div class="flex justify-between items-start">
            <h3 class="font-display text-xl font-bold" id="vocabWord">Word</h3>
            <button class="audio-btn text-sm" onclick="speakWord()">üîä Hear It</button>
          </div>
          <p class="text-lg mb-2 mt-1" id="vocabDef">Definition here</p>
          <p class="text-sm text-gray-500" id="vocabSpanish">En espa√±ol: palabra</p>
        </div>
      </div>
      <div class="bg-amber-50 p-3 rounded-lg">
        <p class="text-sm font-semibold text-amber-800 mb-1">üìñ In the Story:</p>
        <p class="text-sm italic" id="vocabExample">"Example sentence"</p>
      </div>
    </div>
  </div>
  
  <!-- Accessibility Panel -->
  <div class="a11y-panel">
    <div class="a11y-menu" id="a11yMenu">
      <p class="font-semibold mb-3">Reading Settings</p>
      <div class="a11y-toggle">
        <span>üîä Read Aloud</span>
        <div class="toggle" id="toggleAudio" onclick="toggleSetting('audio')"></div>
      </div>
      <div class="a11y-toggle">
        <span>üìñ Dyslexia Font</span>
        <div class="toggle" id="toggleDyslexia" onclick="toggleSetting('dyslexia')"></div>
      </div>
      <div class="a11y-toggle">
        <span>üåô High Contrast</span>
        <div class="toggle" id="toggleContrast" onclick="toggleSetting('contrast')"></div>
      </div>
      <div class="a11y-toggle">
        <span>üìù Show Hints</span>
        <div class="toggle on" id="toggleHints" onclick="toggleSetting('hints')"></div>
      </div>
      <div class="a11y-toggle">
        <span>üè´ SIOP Strategies</span>
        <div class="toggle" id="toggleSiop" onclick="toggleSiopStrategies()"></div>
      </div>
      <div class="a11y-toggle">
        <span>üîÑ Reset Progress</span>
        <button class="text-xs bg-red-100 text-red-700 px-2 py-1 rounded" onclick="resetProgress()">Reset</button>
      </div>
    </div>
    <button class="a11y-btn" onclick="toggleA11yMenu()" aria-label="Accessibility settings">
      ‚öôÔ∏è
    </button>
  </div>

  <!-- SIOP Strategies Modal -->
  <div id="siopModal" class="helper-modal" onclick="closeSiopModal(event)">
    <div class="helper-content border-l-8 border-teal-500" onclick="event.stopPropagation()">
      <div class="flex items-center gap-3 mb-4">
        <div class="text-3xl text-teal-600">üè´</div>
        <h3 class="font-display text-xl font-bold">SIOP Strategies Used</h3>
      </div>
      <div class="space-y-3">
        <div class="siop-strategy">
          <span>üìö</span>
          <span>Vocabulary Pre-teaching</span>
        </div>
        <div class="siop-strategy">
          <span>üó£Ô∏è</span>
          <span>Sentence Frames</span>
        </div>
        <div class="siop-strategy">
          <span>üë•</span>
          <span>Cooperative Learning</span>
        </div>
        <div class="siop-strategy">
          <span>üñºÔ∏è</span>
          <span>Visual Supports</span>
        </div>
        <div class="siop-strategy">
          <span>üîä</span>
          <span>Oral Language Practice</span>
        </div>
        <div class="siop-strategy">
          <span>üìù</span>
          <span>Scaffolded Writing</span>
        </div>
      </div>
      <p class="mt-4 text-xs text-gray-400 text-center">SIOP = Sheltered Instruction Observation Protocol</p>
    </div>
  </div>

  <!-- Main Content -->
  <main class="main-with-rail max-w-4xl mx-auto min-h-screen pb-20">
    <div class="px-4 sm:px-6 lg:px-8">

    <!-- OLD PROGRESS TRACKER REMOVED - NOW IN LEFT RAIL -->
    <!--
    <div class="fixed left-4 top-1/4 bg-white p-4 rounded-xl shadow-lg border border-purple-200 hidden lg:block z-40"
         style="backdrop-filter: blur(10px); background: rgba(255, 255, 255, 0.9);">
      <h4 class="font-bold mb-3 text-purple-700 flex items-center gap-2">
        <span>üìã</span>
        <span>Lesson Progress</span>
      </h4>
      <div class="space-y-2 text-sm">
        <div class="flex items-center gap-2">
          <span id="progress-sel" class="progress-check">‚óª</span>
          <span>Check-In</span>
        </div>
        <div class="flex items-center gap-2">
          <span id="progress-vocab" class="progress-check">‚óª</span>
          <span>Vocabulary</span>
        </div>
        <div class="flex items-center gap-2">
          <span id="progress-section1" class="progress-check">‚óª</span>
          <span>Section 1</span>
        </div>
        <div class="flex items-center gap-2">
          <span id="progress-section2" class="progress-check">‚óª</span>
          <span>Section 2</span>
        </div>
        <div class="flex items-center gap-2">
          <span id="progress-section3" class="progress-check">‚óª</span>
          <span>Section 3</span>
        </div>
        <div class="flex items-center gap-2">
          <span id="progress-drag" class="progress-check">‚óª</span>
          <span>Drag & Drop</span>
        </div>
        <div class="flex items-center gap-2">
          <span id="progress-essay" class="progress-check">‚óª</span>
          <span>Model Essay</span>
        </div>
        <div class="flex items-center gap-2">
          <span id="progress-reflect" class="progress-check">‚óª</span>
          <span>Reflection</span>
        </div>
      </div>
      <div class="mt-3 pt-3 border-t border-gray-200 text-xs text-gray-500">
        <div class="flex justify-between">
          <span>Completed:</span>
          <span id="progress-percentage">0%</span>
        </div>
      </div>
    </div>
    -->

    <!-- SIOP OBJECTIVES BANNER -->
    <div class="bg-gradient-to-r from-teal-50 to-blue-50 p-4 border-b border-teal-200">
      <div class="max-w-4xl mx-auto">
        <h3 class="font-bold text-teal-800 mb-2 flex items-center gap-2" data-i18n="banners.heading">
          <span>üè´</span>
          <span>SIOP Language & Content Objectives</span>
        </h3>
        <div class="grid md:grid-cols-2 gap-4">
          <div class="language-objective">
            <h4 class="font-bold text-green-800 mb-1" data-i18n="banners.language_objective_title">Language Objective:</h4>
            <p data-i18n="banners.language_objective_body">I will use academic vocabulary (claim, evidence, counterclaim) to discuss and write about arguments.</p>
          </div>
          <div class="content-objective">
            <h4 class="font-bold text-amber-800 mb-1" data-i18n="banners.content_objective_title">Content Objective:</h4>
            <p data-i18n="banners.content_objective_body">I will identify and address counterclaims using a 4-step strategy in both discussions and writing.</p>
          </div>
        </div>
      </div>
    </div>

       <!-- HERO SECTION -->
    <header class="relative">
      <img src="header.png" alt="Lee and Tee looking confident" class="w-full">
      <div class="hero-gradient text-white p-8 md:p-12 text-center">
        <div class="inline-block bg-white/20 backdrop-blur px-4 py-1 rounded-full text-sm font-semibold mb-4" data-i18n="story.title">
          üìö Episode 1 ‚Ä¢ ELA: Argumentative Writing
        </div>
        <h1 class="font-display text-4xl md:text-5xl font-bold mb-3" data-i18n="hero.title">The Recess Battle</h1>
        <p class="text-lg opacity-90 max-w-md mx-auto" data-i18n="hero.subtitle">
          How to win an argument without yelling‚Äîa story about <em>loudness</em> vs. <em>logic</em>
        </p>
        
        <!-- Intro video -->
        <div class="mt-6 max-w-sm mx-auto">
          <div class="video-block">
            <iframe src="https://www.youtube.com/embed/jTLr3DcCN8E"
                    style="width: 100%; height: 315px; border: none; border-radius: 8px;"
                    title="Meet Lee & Tee"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                    allowfullscreen>
            </iframe>
            <div class="video-caption">
              <p class="font-semibold">Meet Lee & Tee</p>
            </div>
          </div>
        </div>
        
        <div class="mt-8 bg-white/10 backdrop-blur rounded-xl p-4 max-w-md mx-auto">
          <div class="standard-tag bg-white/20 backdrop-blur border-white/30 text-white mb-2">
            <span class="standard-code" data-i18n="hero.standard_code">CCSS.ELA.W.5.1</span>
            <span data-i18n="hero.standard_label">Opinion Writing with Reasons</span>
          </div>
          <p class="font-semibold mb-2" data-i18n="ui.goal_label">üéØ Today's Goal:</p>
          <p class="text-sm" data-i18n="ui.goal_text">Learn the 4-step structure for addressing counterclaims by watching a rap battle</p>
        </div>
      </div>
    </header>
  </div>
  
  <!-- LEARNING OBJECTIVES -->‚êä
  <section class="bg-white border-b p-6">‚êä
    <div class="flex flex-wrap gap-3 justify-center">
        <div class="section-marker">
          <span class="text-purple-600">üìñ</span>
          <span>Read: 15 min</span>
        </div>
        <div class="section-marker">
          <span class="text-amber-600">‚úçÔ∏è</span>
          <span>Practice: 15 min</span>
        </div>
        <div class="section-marker">
          <span class="text-teal-600">‚úÖ</span>
          <span>Check: 5 min</span>
        </div>
      </div>
    </section>

    <!-- SEL CHECK-IN -->
    <section id="sel-checkin" class="p-8 md:p-12 bg-gradient-to-b from-blue-50 to-white">
      <h2 class="font-display text-2xl font-bold mb-4 text-center" data-translate="sel.question">How are you feeling today?</h2>
      <p class="text-center text-gray-600 mb-6" data-translate="instructions.select_emotion">Choose what describes you best right now:</p>

      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 max-w-2xl mx-auto">
        <div class="emotion-option bg-white" onclick="selectEmotion(this, 'excited')">
          <div class="text-4xl mb-2">üòÑ</div>
          <div class="font-semibold" data-translate="sel.excited">Excited</div>
        </div>
        <div class="emotion-option bg-white" onclick="selectEmotion(this, 'calm')">
          <div class="text-4xl mb-2">üòä</div>
          <div class="font-semibold" data-translate="sel.calm">Calm</div>
        </div>
        <div class="emotion-option bg-white" onclick="selectEmotion(this, 'nervous')">
          <div class="text-4xl mb-2">üò∞</div>
          <div class="font-semibold" data-translate="sel.nervous">Nervous</div>
        </div>
        <div class="emotion-option bg-white" onclick="selectEmotion(this, 'tired')">
          <div class="text-4xl mb-2">üò¥</div>
          <div class="font-semibold" data-translate="sel.tired">Tired</div>
        </div>
      </div>

      <!-- SEL Feedback Message -->
      <div id="selFeedback" class="mt-6 text-center text-purple-700 font-semibold hidden"></div>
    </section>

    <!-- CHARACTER CHOICE -->
    <section id="character-choice" class="p-8 md:p-12 bg-gradient-to-b from-purple-50 to-white">
      <h2 class="font-display text-3xl font-bold mb-4 text-purple-700" data-translate="character.title">Choose Your Learning Guide</h2>
      <p class="text-lg mb-6" data-translate="instructions.select_character">Which character do you want to help first? You'll learn from both, but you choose where to start!</p>

      <div class="grid md:grid-cols-2 gap-6">
        <div id="chooseLee" class="choice-card bg-white p-6 rounded-xl shadow" onclick="chooseCharacter('lee')">
          <div class="text-6xl mb-4 text-center">üìì</div>
          <h3 class="font-display text-2xl font-bold mb-2 text-center" data-translate="character.lee_name">Start with Lee</h3>
          <p class="text-gray-600 text-center" data-translate="character.lee_desc">The analytical thinker who loves to write everything down</p>
        </div>

        <div id="chooseTee" class="choice-card bg-white p-6 rounded-xl shadow" onclick="chooseCharacter('tee')">
          <div class="text-6xl mb-4 text-center">üé§</div>
          <h3 class="font-display text-2xl font-bold mb-2 text-center" data-translate="character.tee_name">Start with Tee</h3>
          <p class="text-gray-600 text-center" data-translate="character.tee_desc">The strategic speaker who thinks on her feet</p>
        </div>
      </div>
      
      <div id="characterFeedback" class="hidden mt-6 p-4 bg-purple-100 rounded-lg text-center">
        <p class="font-bold text-purple-800">Great choice! Let's begin the story...</p>
      </div>
    </section>

           <!-- VOCABULARY PRE-TEACH (Active Prediction) -->
    <div id="words-youll-need" class="anchor-target" aria-hidden="true"></div>
    <section class="p-8 md:p-12 bg-amber-50" id="section-vocab">
      <div class="ritual-marker ritual-stir mb-4" data-translate="vocab.ritual_marker">ü•Ñ Stir It ‚Äî Gather the Ingredients</div>

      <h2 class="font-display text-3xl font-bold mb-4 text-purple-700" data-translate="vocab.title">Words You'll Need</h2>

      <div class="standard-tag mb-6">
        <span class="standard-code">CCSS.ELA.L.5.6</span>
        <span>Acquire and use academic vocabulary</span>
      </div>

      <!-- SIOP Strategy Indicator - NEW -->
      <div class="flex flex-wrap gap-2 mb-4">
        <div class="siop-strategy" data-translate="vocab.siop_vocab">üìö Vocabulary Pre-teaching</div>
        <div class="siop-strategy" data-translate="vocab.siop_visual">üñºÔ∏è Visual Supports</div>
        <div class="siop-strategy" data-translate="vocab.siop_frames">üó£Ô∏è Sentence Frames</div>
      </div>

      <p class="text-lg mb-6" data-translate="vocab.intro">Let's learn three important words. Can you predict which word fits in each sentence?</p>

      <!-- WORD BANK FOR ELL SUPPORT - NEW -->
      <div class="word-bank">
        <p class="font-semibold text-purple-700 mb-2" data-translate="vocab.word_bank">üìñ Word Bank:</p>
        <div class="flex flex-wrap gap-2">
          <span class="bg-white px-3 py-1 rounded-full text-sm font-medium border border-purple-200">Claim</span>
          <span class="bg-white px-3 py-1 rounded-full text-sm font-medium border border-teal-200">Evidence</span>
          <span class="bg-white px-3 py-1 rounded-full text-sm font-medium border border-amber-200">Counterclaim</span>
        </div>
      </div>

<!-- VOCABULARY GALLERY -->
<div class="grid md:grid-cols-3 gap-4 mb-8">
  <!-- CLAIM Card -->
  <div class="bg-white p-4 rounded-xl shadow-sm border border-purple-100 cursor-pointer hover:shadow-md transition group"
       onclick="showVocab('claim')">
    <div class="flex items-center gap-3 mb-3">
      <div class="vocab-image">üì¢</div>
      <div>
        <h4 class="font-bold text-purple-700" data-translate="vocab.claim">Claim</h4>
        <p class="text-xs text-gray-500" data-translate="vocab.claim_subtitle">Your main point or argument</p>
      </div>
    </div>
    <p class="text-sm text-gray-700 mb-3" data-translate="vocab.claim_def">What you're trying to prove in your argument</p>
    <div class="flex items-center justify-between">
      <span class="text-xs bg-purple-50 text-purple-700 px-2 py-1 rounded" data-translate="vocab.claim_example">In story: "Tee never wins..."</span>
      <span class="text-xs text-gray-400" data-translate="vocab.tap_to_learn">Tap to learn</span>
    </div>
  </div>

  <!-- EVIDENCE Card -->
  <div class="bg-white p-4 rounded-xl shadow-sm border border-teal-100 cursor-pointer hover:shadow-md transition group"
       onclick="showVocab('evidence')">
    <div class="flex items-center gap-3 mb-3">
      <div class="vocab-image">üìÑ</div>
      <div>
        <h4 class="font-bold text-teal-700" data-translate="vocab.evidence">Evidence</h4>
        <p class="text-xs text-gray-500" data-translate="vocab.evidence_subtitle">Proof or facts ("receipts")</p>
      </div>
    </div>
    <p class="text-sm text-gray-700 mb-3" data-translate="vocab.evidence_def">Concrete proof that supports your claim</p>
    <div class="flex items-center justify-between">
      <span class="text-xs bg-teal-50 text-teal-700 px-2 py-1 rounded" data-translate="vocab.evidence_example">In story: Attendance records</span>
      <span class="text-xs text-gray-400" data-translate="vocab.tap_to_learn">Tap to learn</span>
    </div>
  </div>

  <!-- COUNTERCLAIM Card -->
  <div class="bg-white p-4 rounded-xl shadow-sm border border-amber-100 cursor-pointer hover:shadow-md transition group"
       onclick="showVocab('counterclaim')">
    <div class="flex items-center gap-3 mb-3">
      <div class="vocab-image">‚ÜîÔ∏è</div>
      <div>
        <h4 class="font-bold text-amber-700" data-translate="vocab.counterclaim">Counterclaim</h4>
        <p class="text-xs text-gray-500" data-translate="vocab.counterclaim_subtitle">Opposing view</p>
      </div>
    </div>
    <p class="text-sm text-gray-700 mb-3" data-translate="vocab.counterclaim_def">The other side's argument you need to address</p>
    <div class="flex items-center justify-between">
      <span class="text-xs bg-amber-50 text-amber-700 px-2 py-1 rounded" data-translate="vocab.counterclaim_example">In story: Jayden's challenge</span>
      <span class="text-xs text-gray-400" data-translate="vocab.tap_to_learn">Tap to learn</span>
    </div>
  </div>
</div>
<!-- END OF VOCABULARY GALLERY -->
    </section>

    <div id="the-story-begins" class="anchor-target" aria-hidden="true"></div>
    <!-- STORY SECTION 1: The Setup -->
<section class="p-8 md:p-12 bg-white" id="section-1">
  <div class="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4 bg-white/60 p-4 rounded-xl">
    <div class="flex items-center gap-3">
      <button class="audio-btn" onclick="toggleSectionAudio(this, 'section-1')" data-translate="section3.listen_btn">
        üîä Listen
      </button>
      <button class="speech-btn flex items-center gap-2" onclick="readAloudWithWordHighlight(this, 'section-1')">
        <span>üéôÔ∏è</span>
        <span data-translate="section3.read_aloud_btn">Read Aloud</span>
      </button>
      <span class="text-sm text-gray-500 hidden md:inline">Section 1 of 6</span>
    </div>
    
    <div class="flex items-center gap-3">
      <button onclick="showSimplifiedText('section-1')" class="text-sm text-gray-600 hover:text-purple-700 px-3 py-1 bg-gray-100 rounded-lg">
        üìù Simplified View
      </button>
      <div class="standard-tag">
        <span class="standard-code">CCSS.ELA.RL.5.1</span>
        <span>Quote accurately</span>
      </div>
    </div>
  </div>
  
  <!-- SENTENCE FRAMES FOR ELL - NEW -->
  <div class="sentence-frame mb-4">
    <p class="text-sm font-semibold text-blue-700 mb-1" data-i18n="section3.ritual_marker">üó£Ô∏è Sentence Frames for This Section:</p>
    <p class="text-sm" data-i18n="instructions.fill_blank">"Ms. Rodriguez explained that we need to ________, ________, and ________ in our essays."</p>
  </div>
  
  <div class="story-text space-y-4" data-story-section="section-1">
  </div>

  <div class="speech-bubble">
    <p class="font-semibold">Ms. Rodriguez:</p>
    <p data-i18n="section3.ms_rodriguez_intro">"Your opinion essay is due Friday. You need to state a <span class="vocab-word" onclick="showVocab('claim')">claim</span>, provide <span class="vocab-word" onclick="showVocab('evidence')">evidence</span>, address a <span class="vocab-word" onclick="showVocab('counterclaim')">counterclaim</span>, and draw a conclusion. This is argumentative writing. Use facts, not feelings."</p>
  </div>

  <!-- Classroom image -->
  <div class="media-container">
    <img src="Gemini_Generated_Image_cuhlvucuhlvucuhl.png" alt="Playground setting with noise and static">
  </div>
  
  <!-- Comprehension check -->
  <div class="mt-8 p-6 bg-teal-50 rounded-xl border border-teal-200">
    <p class="font-semibold mb-3">ü§î Think About It (DOK 1):</p>
    <p class="mb-4">What part of argumentative writing does Lee find confusing?</p>
    <div class="space-y-2">
      <button class="quiz-option w-full text-left" onclick="checkAnswer(this, false, 'comp1')">A) Stating a claim</button>
      <button class="quiz-option w-full text-left" onclick="checkAnswer(this, false, 'comp1')">B) Providing evidence</button>
      <button class="quiz-option w-full text-left" onclick="checkAnswer(this, true, 'comp1')">C) Addressing a counterclaim</button>
      <button class="quiz-option w-full text-left" onclick="checkAnswer(this, false, 'comp1')">D) Writing a conclusion</button>
    </div>
    <p class="mt-3 text-green-600 font-semibold hidden" id="comp1-feedback" data-i18n="feedback.comp1">‚úì Right! Lee says the counterclaim part feels "slippery" and "hard to hold."</p>
  </div>
</section>

<!-- VOCABULARY APPLICATION - NOW THAT YOU'VE SEEN THE WORDS -->
<section class="p-8 md:p-12 bg-amber-50">
  <h3 class="font-display text-2xl font-bold mb-4 text-purple-700">Now You Try: Use the Words</h3>
  <p class="text-lg mb-6">You just read those three words in the story. Now can you identify which word fits in each sentence?</p>

  <!-- FILL-IN-THE-BLANK ACTIVITY (moved from vocabulary section) -->
  <div class="space-y-6">
    <!-- BLANK 1: CLAIM -->
    <div class="bg-white p-6 rounded-lg shadow">
      <p class="text-lg mb-4">
        1. "Tee never wins at anything!" is Jayden's
        <span class="vocab-predict">
          <span class="vocab-blank" id="blank1" onclick="showVocabChoices('blank1', 'claim')">___</span>
          <div id="choices1" class="vocab-choices">
            <button class="vocab-choice-btn" onclick="checkVocabChoice('blank1', 'choices1', 'evidence', false)">evidence</button>
            <button class="vocab-choice-btn" onclick="checkVocabChoice('blank1', 'choices1', 'claim', true)">claim</button>
            <button class="vocab-choice-btn" onclick="checkVocabChoice('blank1', 'choices1', 'counterclaim', false)">counterclaim</button>
          </div>
        </span>
        ‚Äî his main point.
      </p>
      <div id="feedback1" class="hidden mt-4 p-4 bg-green-100 rounded-lg">
        <p class="font-bold text-green-800">‚úì Correct! A <strong>claim</strong> is your main point or what you're trying to prove.</p>
        <p class="text-sm mt-2 text-green-700">En espa√±ol: afirmaci√≥n</p>
      </div>
    </div>

    <!-- BLANK 2: EVIDENCE -->
    <div class="bg-white p-6 rounded-lg shadow">
      <p class="text-lg mb-4">
        2. Tee brought
        <span class="vocab-predict">
          <span class="vocab-blank" id="blank2" onclick="showVocabChoices('blank2', 'evidence')">___</span>
          <div id="choices2" class="vocab-choices">
            <button class="vocab-choice-btn" onclick="checkVocabChoice('blank2', 'choices2', 'evidence', true)">evidence</button>
            <button class="vocab-choice-btn" onclick="checkVocabChoice('blank2', 'choices2', 'claim', false)">claim</button>
            <button class="vocab-choice-btn" onclick="checkVocabChoice('blank2', 'choices2', 'counterclaim', false)">counterclaim</button>
          </div>
        </span>
        when she said "Ms. R checked attendance... I been on-time all quarter."
      </p>
      <div id="feedback2" class="hidden mt-4 p-4 bg-green-100 rounded-lg">
        <p class="font-bold text-green-800">‚úì Correct! <strong>Evidence</strong> is proof or facts that support your claim. We also call these "receipts"!</p>
        <p class="text-sm mt-2 text-green-700">En espa√±ol: evidencia, prueba</p>
      </div>
    </div>

    <!-- BLANK 3: COUNTERCLAIM -->
    <div class="bg-white p-6 rounded-lg shadow">
      <p class="text-lg mb-4">
        3. A
        <span class="vocab-predict">
          <span class="vocab-blank" id="blank3" onclick="showVocabChoices('blank3', 'counterclaim')">___</span>
          <div id="choices3" class="vocab-choices">
            <button class="vocab-choice-btn" onclick="checkVocabChoice('blank3', 'choices3', 'evidence', false)">evidence</button>
            <button class="vocab-choice-btn" onclick="checkVocabChoice('blank3', 'choices3', 'claim', false)">claim</button>
            <button class="vocab-choice-btn" onclick="checkVocabChoice('blank3', 'choices3', 'counterclaim', true)">counterclaim</button>
          </div>
        </span>
        is the other side's argument that you need to address.
      </p>
      <div id="feedback3" class="hidden mt-4 p-4 bg-green-100 rounded-lg">
        <p class="font-bold text-green-800">‚úì Correct! A <strong>counterclaim</strong> is the opposing view. Addressing it means explaining why that view is weak.</p>
        <p class="text-sm mt-2 text-green-700">En espa√±ol: contraargumento</p>
      </div>
    </div>
  </div>
</section>

    <!-- STORY SECTION 2: The Playground -->
<section class="p-8 md:p-12 bg-slate-50" id="section-2">
  <div class="flex items-center justify-between mb-6">
    <div class="flex items-center gap-3">
      <button class="audio-btn" onclick="toggleSectionAudio(this, 'section-2')">
        üîä Listen
      </button>
      <button class="speech-btn flex items-center gap-2" onclick="readAloudWithWordHighlight(this, 'section-2')">
        <span>üéôÔ∏è</span>
        <span>Read Aloud</span>
      </button>
      <span class="text-sm text-gray-500">Section 2 of 6</span>
    </div>
    <div class="standard-tag">
      <span class="standard-code">CCSS.ELA.SL.5.3</span>
      <span>Summarize speaker's claims</span>
    </div>
  </div>
  
  <div class="story-text space-y-4" data-story-section="section-2">
  </div>

  <div class="bg-amber-100 p-4 rounded-lg my-6 border-l-4 border-amber-500">
    <p class="font-semibold" data-i18n="story.highlight_battle">"That is definitely a battle,"</p>
    <p class="text-sm text-amber-800 mt-1" data-i18n="story.tee_heading_in">‚Äî Tee said. He was already walking toward it.</p>
  </div>
  
  <!-- Character comparison images -->
  <div class="media-grid">
    <div class="text-center p-4 bg-purple-50 rounded-lg">
      <div class="text-4xl mb-2">üìì</div>
      <p class="font-semibold" data-i18n="story.characters.lee_label">Lee</p>
      <p class="text-sm text-gray-600" data-i18n="story.characters.lee_desc">Hangs back, hugs notebook, doesn't like noise</p>
    </div>
    <div class="text-center p-4 bg-amber-50 rounded-lg">
      <div class="text-4xl mb-2">üé§</div>
      <p class="font-semibold" data-i18n="story.characters.tee_label">Tee</p>
      <p class="text-sm text-gray-600" data-i18n="story.characters.tee_desc">Walks toward noise, confident, ready</p>
    </div>
  </div>

</section>

    <!-- STORY SECTION 3: Jayden's Challenge -->
<section class="p-8 md:p-12 bg-white" id="section-3">
  <div class="flex items-center justify-between mb-6">
    <div class="flex items-center gap-3">
      <button class="audio-btn" onclick="toggleSectionAudio(this, 'section-3')">
        üîä Listen
      </button>
      <button class="speech-btn flex items-center gap-2" onclick="readAloudWithWordHighlight(this, 'section-3')">
        <span>üéôÔ∏è</span>
        <span>Read Aloud</span>
      </button>
      <span class="text-sm text-gray-500">Section 3 of 6</span>
    </div>
    <div class="standard-tag">
      <span class="standard-code">CCSS.ELA.SL.5.3</span>
      <span>Summarize speaker's claims</span>
    </div>
  </div>
  
  <!-- Jayden images -->
  <div class="media-grid mb-6">
    <img src="Gemini_Generated_Image_ktkt54ktkt54ktkt.png" alt="Jayden challenging aggressively" class="media-container">
    <img src="Gemini_Generated_Image_k7tn0nk7tn0nk7tn.png" alt="Battle circle with argument in action" class="media-container">
  </div>
  
  <div class="story-text space-y-4" data-story-section="section-3">
  </div>

  <div class="bg-red-50 p-4 rounded-lg my-6 border-l-4 border-red-500">
    <p class="font-semibold" data-i18n="story.jayden_taunt">"There you go. Big talk Tee. Try not to choke."</p>
    <p class="text-sm text-red-700 mt-1" data-i18n="story.jayden_loud">‚Äî Jayden said, loud enough for everyone to hear.</p>
  </div>

  <!-- OPTIONAL: Watch Jayden's Rap Video -->
  <div class="mt-6 p-4 bg-blue-50 border-2 border-blue-300 rounded-xl">
    <div class="flex items-center gap-2 mb-3">
      <span class="text-2xl">üé¨</span>
      <p class="font-semibold text-blue-900">Optional: Watch Jayden Perform His Verse</p>
    </div>
    <p class="text-sm text-blue-800 mb-4">Want to see it performed? Click play below, or keep reading to see the text version.</p>
    <div class="video-block max-w-md mx-auto">
      <video controls poster="Gemini_Generated_Image_ktkt54ktkt54ktkt.png" class="rounded-lg">
        <source src="jayden's_rap.mp4" type="video/mp4">
        Your browser does not support the video tag.
      </video>
    </div>
  </div>

  <!-- JAYDEN'S RAP - Interactive Analysis -->
  <div class="mt-6 bg-slate-900 text-white p-6 rounded-xl">
    <div class="flex items-center gap-2 mb-4">
      <span class="text-2xl">üé§</span>
      <h3 class="font-display text-xl font-bold">Jayden's Verse</h3>
    </div>
    
    <div class="space-y-3 mb-6 font-mono">
      <p>"You always brag loud like you run this whole school,</p>
      <p>But you late to first period and you act like that's cool.</p>
      <p>You talk like you're top, but you never come through,</p>
      <p>If they needed a leader, it definitely ain't you."</p>
    </div>
    
    <div class="bg-slate-800 p-4 rounded-lg">
      <p class="text-amber-400 font-semibold mb-2">‚ö° The crowd erupted!</p>
      <p class="text-slate-300 text-sm">Somebody yelled "OHHH!" Hands flew to mouths. Feet stomped.</p>
    </div>
  </div>
  
  <!-- Tee's Analysis (Think-aloud) -->
  <div class="mt-6 p-6 bg-purple-50 rounded-xl border-2 border-purple-200">
    <!-- Visual: Tee and Lee talking at recess -->
    <div class="mb-4">
      <img src="Gemini_Generated_Image_v6x547v6x547v6x5.png" alt="Tee and Lee talking during the recess battle" class="media-container rounded-lg">
    </div>

    <div class="flex items-start gap-3">
      <div class="text-3xl">üß†</div>
      <div>
        <p class="font-semibold text-purple-800 mb-2">What Tee Noticed:</p>
        <p class="text-purple-900">He tilted his head toward Lee just enough for her to hear:</p>
        <p class="mt-2 font-semibold italic">"He made a <span class="vocab-word bg-yellow-200" onclick="showVocab('claim')">claim</span>, but he gave zero facts. No quiz name, no test score, nothing. That is weak."</p>
      </div>
    </div>
  </div>
  
  <!-- Comprehension check -->
  <div class="mt-6 p-6 bg-teal-50 rounded-xl border border-teal-200">
    <p class="font-semibold mb-3">ü§î Think About It:</p>
    <p class="mb-4">What does Tee say is MISSING from Jayden's rap?</p>
    <div class="space-y-2">
      <button class="quiz-option w-full text-left" onclick="checkAnswer(this, false, 'comp2')">A) Rhymes</button>
      <button class="quiz-option w-full text-left" onclick="checkAnswer(this, true, 'comp2')">B) Proof / Evidence</button>
      <button class="quiz-option w-full text-left" onclick="checkAnswer(this, false, 'comp2')">C) Volume</button>
      <button class="quiz-option w-full text-left" onclick="checkAnswer(this, false, 'comp2')">D) Confidence</button>
    </div>
    <p class="mt-3 text-green-600 font-semibold hidden" id="comp2-feedback" data-i18n="feedback.comp2">‚úì Exactly! Tee noticed Jayden made claims but gave "zero facts" - no proof at all.</p>
  </div>

  <!-- ACTIVE LEARNING: Identify the Problem -->
  <div class="mt-8 p-6 bg-yellow-50 rounded-xl">
    <h3 class="font-display text-2xl font-bold mb-4">ü§î Think About It (DOK 2)</h3>

    <p class="text-lg mb-6">Listen to Jayden's argument. What's the problem with it? Choose all that apply:</p>

    <div class="space-y-3">
      <label class="flex items-start gap-3 p-4 bg-white rounded-lg cursor-pointer hover:bg-yellow-100 transition">
        <input type="checkbox" class="mt-1 problem-check" data-correct="false">
        <span>He's speaking too loudly</span>
      </label>
      <label class="flex items-start gap-3 p-4 bg-white rounded-lg cursor-pointer hover:bg-yellow-100 transition">
        <input type="checkbox" class="problem-check" data-correct="true">
        <span>He makes claims without evidence</span>
      </label>
      <label class="flex items-start gap-3 p-4 bg-white rounded-lg cursor-pointer hover:bg-yellow-100 transition">
        <input type="checkbox" class="problem-check" data-correct="true">
        <span>He uses generalizations like "never" and "always"</span>
      </label>
      <label class="flex items-start gap-3 p-4 bg-white rounded-lg cursor-pointer hover:bg-yellow-100 transition">
        <input type="checkbox" class="problem-check" data-correct="false">
        <span>He's talking during recess</span>
      </label>
    </div>

    <button onclick="checkProblemAnswers()" class="mt-4 bg-teal-600 text-white px-6 py-3 rounded-lg font-bold hover:bg-teal-700 transition w-full">
      Check My Thinking
    </button>

    <div id="problemFeedback" class="hidden mt-4 p-4 bg-green-100 rounded-lg">
      <p class="font-bold text-green-800 mb-2" data-i18n="ui.great_work">‚úì Great analysis!</p>
      <p data-i18n="feedback.problem_explanation">Jayden's argument is weak because he makes big claims ("never wins at nothing") without any proof. That's called an <strong>unsupported claim</strong>. Let's see how Tee responds...</p>
    </div>
  </div>
</section>

    <div id="tees-4-step-strategy" class="anchor-target" aria-hidden="true"></div>
    <!-- STORY SECTION 4: Tee's Response -->
<section class="p-8 md:p-12 bg-gradient-to-b from-purple-50 to-white" id="section-4">
  <div class="flex items-center justify-between mb-6">
    <div class="flex items-center gap-3">
      <button class="audio-btn" onclick="toggleSectionAudio(this, 'section-4')">
        üîä Listen
      </button>
      <button class="speech-btn flex items-center gap-2" onclick="readAloudWithWordHighlight(this, 'section-4')">
        <span>üéôÔ∏è</span>
        <span>Read Aloud</span>
      </button>
      <span class="text-sm text-gray-500">Section 4 of 6</span>
    </div>
    <div class="standard-tag">
      <span class="standard-code">CCSS.ELA.W.5.1.B</span>
      <span>Support with reasons & evidence</span>
    </div>
  </div>
  
  <!-- Tee preparing video -->
   <div class="video-block max-w-md mx-auto">
  <video controls poster="Gemini_Generated_Image_fk641wfk641wfk64.png">
  <source src="./tee_battle_back.mp4?v=2" type="video/mp4">
  Your browser does not support the video tag.
</video>
    <div class="video-caption">
      <p>Tee stays calm. He's thinking, not panicking.</p>
    </div>
  </div>
  
  <h2 class="font-display text-3xl font-bold mb-6 text-purple-700">Tee's 4-Step Strategy</h2>
      
      <!-- SIOP Cooperative Learning Prompt - NEW -->
      <div class="bg-blue-50 p-4 rounded-lg mb-4">
        <p class="font-semibold text-blue-800 mb-1">üë• SIOP Strategy: Turn & Talk</p>
        <p class="text-sm">Before reading, turn to a partner and predict: What 4 steps do you think Tee will use to respond?</p>
      </div>
      
      <div class="story-text space-y-4 mb-8" data-story-section="section-4">
      </div>
      
      <!-- INTERACTIVE STRATEGY SEQUENCE -->
      <div class="space-y-6">
        <div class="bg-amber-100 p-6 rounded-xl border-l-4 border-amber-500">
          <div class="flex items-start gap-4">
            <div class="bg-amber-500 text-white font-bold w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 text-xl">1</div>
            <div>
              <h4 class="font-bold text-xl mb-2">State what they said</h4>
              <p class="text-gray-700 mb-3">"You claim I 'never win at nothing' and I'm 'always late.'"</p>
              <div class="bg-white p-3 rounded-lg text-sm">
                <strong>Strategy Tip:</strong> Repeat their claim to show you heard it accurately
              </div>
            </div>
          </div>
        </div>

        <div class="bg-teal-100 p-6 rounded-xl border-l-4 border-teal-500">
          <div class="flex items-start gap-4">
            <div class="bg-teal-500 text-white font-bold w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 text-xl">2</div>
            <div>
              <h4 class="font-bold text-xl mb-2">Show your evidence</h4>
              <p class="text-gray-700 mb-3">"Ms. R checked attendance. Look at the board ‚Äî I been on-time all quarter. That's ten weeks straight."</p>
              <div class="bg-white p-3 rounded-lg text-sm">
                <strong>Strategy Tip:</strong> Bring specific, verifiable facts
              </div>
            </div>
          </div>
        </div>

        <div class="bg-purple-100 p-6 rounded-xl border-l-4 border-purple-500">
          <div class="flex items-start gap-4">
            <div class="bg-purple-500 text-white font-bold w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 text-xl">3</div>
            <div>
              <h4 class="font-bold text-xl mb-2">Explain why their claim is wrong</h4>
              <p class="text-gray-700 mb-3">"So your whole argument? It's based on old information. That's not facts, that's assumptions."</p>
              <div class="bg-white p-3 rounded-lg text-sm">
                <strong>Strategy Tip:</strong> Connect your evidence to why their claim doesn't hold up
              </div>
            </div>
          </div>
        </div>

        <div class="bg-rose-100 p-6 rounded-xl border-l-4 border-rose-500">
          <div class="flex items-start gap-4">
            <div class="bg-rose-500 text-white font-bold w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 text-xl">4</div>
            <div>
              <h4 class="font-bold text-xl mb-2">Restate your position</h4>
              <p class="text-gray-700 mb-3">"I show up. I do my work. Period."</p>
              <div class="bg-white p-3 rounded-lg text-sm">
                <strong>Strategy Tip:</strong> End strong and clear with your main point
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- GUIDED PRACTICE: IDENTIFY FIRST -->
      <div class="mt-8 p-6 bg-purple-50 rounded-xl">
        <h3 class="font-display text-2xl font-bold mb-4 text-purple-700">üîç Guided Practice: Identify Each Step</h3>
        <p class="text-lg mb-6">Before you sequence the rap lines, let's identify where Tee used each step in her response. Click the button that matches each statement:</p>

        <div class="space-y-4">
          <!-- GUIDED ITEM 1 -->
          <div class="bg-white p-4 rounded-lg">
            <p class="font-semibold mb-3">"You claim I 'never win at nothing' and I'm 'always late.'"</p>
            <p class="text-sm text-gray-600 mb-3">Which step is this?</p>
            <div class="flex flex-wrap gap-2">
              <button class="px-4 py-2 bg-gray-100 rounded hover:bg-amber-100 transition" onclick="checkGuidedStep(this, true, 'guided1')">Step 1: State what they said</button>
              <button class="px-4 py-2 bg-gray-100 rounded hover:bg-amber-100 transition" onclick="checkGuidedStep(this, false, 'guided1')">Step 2: Show evidence</button>
              <button class="px-4 py-2 bg-gray-100 rounded hover:bg-amber-100 transition" onclick="checkGuidedStep(this, false, 'guided1')">Step 3: Explain why wrong</button>
              <button class="px-4 py-2 bg-gray-100 rounded hover:bg-amber-100 transition" onclick="checkGuidedStep(this, false, 'guided1')">Step 4: Restate position</button>
            </div>
            <p id="guided1-feedback" class="hidden mt-2 text-green-700 font-semibold" data-i18n="feedback.guided1">‚úì Correct! Tee is repeating what Jayden claimed.</p>
          </div>

          <!-- GUIDED ITEM 2 -->
          <div class="bg-white p-4 rounded-lg">
            <p class="font-semibold mb-3">"Ms. R checked attendance. Look at the board ‚Äî I been on-time all quarter."</p>
            <p class="text-sm text-gray-600 mb-3">Which step is this?</p>
            <div class="flex flex-wrap gap-2">
              <button class="px-4 py-2 bg-gray-100 rounded hover:bg-amber-100 transition" onclick="checkGuidedStep(this, false, 'guided2')">Step 1: State what they said</button>
              <button class="px-4 py-2 bg-gray-100 rounded hover:bg-amber-100 transition" onclick="checkGuidedStep(this, true, 'guided2')">Step 2: Show evidence</button>
              <button class="px-4 py-2 bg-gray-100 rounded hover:bg-amber-100 transition" onclick="checkGuidedStep(this, false, 'guided2')">Step 3: Explain why wrong</button>
              <button class="px-4 py-2 bg-gray-100 rounded hover:bg-amber-100 transition" onclick="checkGuidedStep(this, false, 'guided2')">Step 4: Restate position</button>
            </div>
            <p id="guided2-feedback" class="hidden mt-2 text-green-700 font-semibold" data-i18n="feedback.guided2">‚úì Yes! Tee is bringing facts and receipts.</p>
          </div>

          <!-- GUIDED ITEM 3 -->
          <div class="bg-white p-4 rounded-lg">
            <p class="font-semibold mb-3">"Your whole argument? It's based on old information. That's not facts, that's assumptions."</p>
            <p class="text-sm text-gray-600 mb-3">Which step is this?</p>
            <div class="flex flex-wrap gap-2">
              <button class="px-4 py-2 bg-gray-100 rounded hover:bg-amber-100 transition" onclick="checkGuidedStep(this, false, 'guided3')">Step 1: State what they said</button>
              <button class="px-4 py-2 bg-gray-100 rounded hover:bg-amber-100 transition" onclick="checkGuidedStep(this, false, 'guided3')">Step 2: Show evidence</button>
              <button class="px-4 py-2 bg-gray-100 rounded hover:bg-amber-100 transition" onclick="checkGuidedStep(this, true, 'guided3')">Step 3: Explain why wrong</button>
              <button class="px-4 py-2 bg-gray-100 rounded hover:bg-amber-100 transition" onclick="checkGuidedStep(this, false, 'guided3')">Step 4: Restate position</button>
            </div>
            <p id="guided3-feedback" class="hidden mt-2 text-green-700 font-semibold" data-i18n="feedback.guided3">‚úì Perfect! Tee is connecting her evidence to why Jayden's claim fails.</p>
          </div>

          <div id="guidedComplete" class="hidden mt-4 p-4 bg-green-100 rounded-lg">
            <p class="font-bold text-green-800" data-i18n="feedback.guided_complete">üéâ Great! Now you're ready to sequence the rap lines.</p>
          </div>
        </div>
      </div>

      <!-- DRAG AND DROP PRACTICE -->
      <div class="mt-8 p-6 bg-gradient-to-b from-purple-50 to-white rounded-xl">
        <h3 class="font-display text-2xl font-bold mb-4 text-purple-700">Practice: Put the Steps in Order</h3>
        
        <p class="text-lg mb-6">Drag each rap line to match Tee's 4-step strategy:</p>
        
        <div class="grid md:grid-cols-2 gap-8">
          <div>
            <h4 class="font-semibold mb-3">Tee's Rap Lines (Drag these):</h4>
            <div class="space-y-2" id="rapLines">
              <div class="rap-line" draggable="true" data-step="2">
                "Got the stats, got the facts, check the attendance pack"
              </div>
              <div class="rap-line" draggable="true" data-step="4">
                "I'm on time, that's my grind, leave your lies behind"
              </div>
              <div class="rap-line" draggable="true" data-step="1">
                "You said I'm always late, that's your whole debate"
              </div>
              <div class="rap-line" draggable="true" data-step="3">
                "Your claim's from last year, but I'm right here"
              </div>
            </div>
          </div>
          
          <div>
            <h4 class="font-semibold mb-3">Match to These Steps:</h4>
            <div class="space-y-3">
              <div class="drop-zone" data-target="1" ondragover="dragOver(event)" ondragleave="dragLeave(event)" ondrop="drop(event)">
                <span class="text-gray-400">Step 1: State what they said</span>
              </div>
              <div class="drop-zone" data-target="2" ondragover="dragOver(event)" ondragleave="dragLeave(event)" ondrop="drop(event)">
                <span class="text-gray-400">Step 2: Show your evidence</span>
              </div>
              <div class="drop-zone" data-target="3" ondragover="dragOver(event)" ondragleave="dragLeave(event)" ondrop="drop(event)">
                <span class="text-gray-400">Step 3: Explain why they're wrong</span>
              </div>
              <div class="drop-zone" data-target="4" ondragover="dragOver(event)" ondragleave="dragLeave(event)" ondrop="drop(event)">
                <span class="text-gray-400">Step 4: Restate your position</span>
              </div>
            </div>
          </div>
        </div>
        
        <div id="strategyFeedback" class="hidden mt-6 p-6 bg-green-100 rounded-xl">
          <p class="font-bold text-green-800 text-lg mb-2">üéâ Perfect! You matched all the steps!</p>
          <p class="text-green-700">Notice how Tee follows each step in order ‚Äî that's what makes her argument so strong. Now it's your turn to try!</p>
        </div>
      </div>
      
      <!-- The result images -->
      <div class="media-grid mt-6">
        <img src="Gemini_Generated_Image_upyw6mupyw6mupyw.png" alt="Jayden stunned scratching his head" class="media-container">
        <img src="Gemini_Generated_Image_jhb8wijhb8wijhb8.png" alt="Tee walking away victoriously" class="media-container">
      </div>
      
      <div class="story-text mt-4" data-story-section="section-4-summary">
      </div>
    </section>

    <!-- THE AH-HA MOMENT: Two Column Chart -->
    <section class="p-8 md:p-12 bg-gradient-to-b from-amber-50 to-white" id="section-aha">
      <div class="ritual-marker ritual-eat mb-4">üçΩÔ∏è You Just Ate It ‚Äî Show What You Know</div>
      
      <h2 class="font-display text-3xl font-bold mb-2 text-purple-700">Lee's Discovery</h2>
      <p class="text-gray-600 mb-6">Lee opened her notebook. The battle itself moved too fast for her to catch every word, but she could capture the structure.</p>
      
      <!-- Lee's notebook image -->
      <div class="media-container mb-6" style="max-width: 500px; margin: 0 auto;">
        <img src="Gemini_Generated_Image_8qgtlc8qgtlc8qgt.png" alt="Lee's notebook showing 'Loud is not the same as true'">
      </div>
      
      <!-- Two Column Comparison -->
      <div class="grid md:grid-cols-2 gap-4 mb-6">
        <div class="strategy-column">
          <div class="header bg-amber-100 text-amber-900">
            üé§ What Tee Did (Rap Battle)
          </div>
          <div class="row">1. Repeat what they said</div>
          <div class="row">2. Show what is missing</div>
          <div class="row">3. Bring real evidence</div>
          <div class="row">4. Turn it into the punchline</div>
        </div>
        
        <div class="strategy-column">
          <div class="header bg-purple-100 text-purple-900">
            üìù What Ms. Rodriguez Wants (Essay)
          </div>
          <div class="row">1. Restate the opposing claim</div>
          <div class="row">2. Identify insufficient evidence</div>
          <div class="row">3. Provide counter-evidence</div>
          <div class="row">4. Draw a logical conclusion</div>
        </div>
      </div>
      
      <!-- Lee's realization -->
      <div class="bg-purple-100 p-6 rounded-xl border-2 border-purple-300">
        <div class="flex items-start gap-4">
          <div class="text-4xl">üí°</div>
          <div>
            <p class="font-bold text-purple-900 text-lg mb-2">Lee's Ah-Ha Moment:</p>
            <p class="text-purple-800 italic text-lg">
              "It's the same! It's the exact same thing. You were addressing Jayden's claim. That's what Ms. Rodriguez called it‚Äîa <strong>counterclaim</strong>."
            </p>
            <p class="mt-4 text-purple-900">
              For the first time all day, the homework assignment did not feel slippery anymore. It felt like something she could actually do.
            </p>
          </div>
        </div>
      </div>
      
      <!-- BONUS: Street Language to School Language Matching -->
<div class="mt-6 p-4 bg-white rounded-xl border">
  <p class="font-semibold mb-4 text-purple-700">üß© Bonus Challenge: Match Street Language to School Language!</p>
  
  <div class="space-y-3">
    <div class="flex flex-wrap items-center gap-3">
      <span class="bg-amber-100 px-3 py-1 rounded font-semibold text-sm">"Repeat what they said"</span>
      <span class="text-gray-400">=</span>
      <select class="border-2 border-purple-200 rounded px-3 py-2" onchange="checkMatch(this, 'restate')">
        <option value="">Choose...</option>
        <option value="restate">Restate the opposing claim</option>
        <option value="identify">Identify insufficient evidence</option>
        <option value="provide">Provide counter-evidence</option>
        <option value="draw">Draw a logical conclusion</option>
      </select>
    </div>
    <div class="flex flex-wrap items-center gap-3">
      <span class="bg-amber-100 px-3 py-1 rounded font-semibold text-sm">"Show what is missing"</span>
      <span class="text-gray-400">=</span>
      <select class="border-2 border-purple-200 rounded px-3 py-2" onchange="checkMatch(this, 'identify')">
        <option value="">Choose...</option>
        <option value="restate">Restate the opposing claim</option>
        <option value="identify">Identify insufficient evidence</option>
        <option value="provide">Provide counter-evidence</option>
        <option value="draw">Draw a logical conclusion</option>
      </select>
    </div>
    <div class="flex flex-wrap items-center gap-3">
      <span class="bg-amber-100 px-3 py-1 rounded font-semibold text-sm">"Bring real evidence"</span>
      <span class="text-gray-400">=</span>
      <select class="border-2 border-purple-200 rounded px-3 py-2" onchange="checkMatch(this, 'provide')">
        <option value="">Choose...</option>
        <option value="restate">Restate the opposing claim</option>
        <option value="identify">Identify insufficient evidence</option>
        <option value="provide">Provide counter-evidence</option>
        <option value="draw">Draw a logical conclusion</option>
      </select>
    </div>
    <div class="flex flex-wrap items-center gap-3">
      <span class="bg-amber-100 px-3 py-1 rounded font-semibold text-sm">"Turn it into a punchline"</span>
      <span class="text-gray-400">=</span>
      <select class="border-2 border-purple-200 rounded px-3 py-2" onchange="checkMatch(this, 'draw')">
        <option value="">Choose...</option>
        <option value="restate">Restate the opposing claim</option>
        <option value="identify">Identify insufficient evidence</option>
        <option value="provide">Provide counter-evidence</option>
        <option value="draw">Draw a logical conclusion</option>
      </select>
    </div>
  </div>
  
  <p id="matchFeedback" class="mt-4 text-green-600 font-semibold hidden" data-i18n="feedback.match_success">‚úì You matched them all! Street smarts = Book smarts!</p>
</div>
    </section>

    <div id="lees-essay-model" class="anchor-target" aria-hidden="true"></div>
    <!-- LEE'S MODEL ESSAY - INTERACTIVE -->
    <section class="p-8 md:p-12 bg-slate-50" id="section-essay">
      <h2 class="font-display text-3xl font-bold mb-2 text-purple-700" data-i18n="section5.title">Lee's Essay (Model)</h2>
      <p class="text-gray-600 mb-6" data-i18n="section5.intro">Using what she learned, Lee wrote her argumentative essay. Now it's YOUR turn to find the parts!</p>

      <!-- Study image -->
      <div class="media-container mb-6" style="max-width: 400px;">
        <img src="Gemini_Generated_Image_8qgtlc8qgtlc8qgt.png" alt="Lee's notebook with essay">
      </div>

      <!-- INTERACTIVE CHALLENGE -->
      <div class="bg-gradient-to-r from-purple-100 to-amber-100 p-6 rounded-xl mb-6">
        <h3 class="font-bold text-xl mb-3" data-i18n="section5.find_parts">üéØ Interactive Challenge:</h3>
        <p class="mb-4" data-i18n="section5.instruction">Click a button below, then click the paragraph that contains that part!</p>

        <div class="flex flex-wrap gap-3 mb-4">
          <button id="btn-claim" onclick="highlightEssayPart('claim')"
            class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition"
            data-part-name="Claim" data-i18n="section5.find_claim">
            Find the CLAIM
          </button>
          <button id="btn-evidence" onclick="highlightEssayPart('evidence')"
            class="px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 transition"
            data-part-name="Evidence" data-i18n="section5.find_evidence">
            Find the EVIDENCE
          </button>
          <button id="btn-counterclaim" onclick="highlightEssayPart('counterclaim')"
            class="px-4 py-2 bg-rose-600 text-white rounded-lg hover:bg-rose-700 transition"
            data-part-name="Counterclaim" data-i18n="section5.find_counterclaim">
            Find the COUNTERCLAIM
          </button>
          <button id="btn-conclusion" onclick="highlightEssayPart('conclusion')"
            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition"
            data-part-name="Conclusion" data-i18n="section5.find_conclusion">
            Find the CONCLUSION
          </button>
        </div>

        <p id="essay-instruction" class="text-sm text-gray-700 font-semibold" data-i18n="section5.instruction">üëÜ Click a button above to start!</p>
      </div>

      <!-- THE ESSAY - NOW CLICKABLE -->
      <div class="notebook">
        <div class="pl-8">
          <h3 class="font-bold text-lg mb-3">Why Rap Battles Can Teach Argumentative Writing</h3>
          <p class="font-semibold text-sm text-gray-500 mb-4">By Lee</p>

          <!-- PARAGRAPH 1: INTRO/CLAIM -->
          <div id="paragraph-intro" onclick="checkEssayPart('intro', 'claim')"
            class="mb-4 p-3 rounded-lg cursor-pointer hover:bg-purple-50 transition border-2 border-transparent">
            <p>At recess today, I watched my brother Tee win a battle against Jayden, and it made me finally understand what Ms. Rodriguez has been trying to teach us. <strong>Rap battles should be used to help students learn argumentative writing because they use the same exact structure we need in our essays.</strong></p>
          </div>

          <!-- PARAGRAPH 2: BODY/EVIDENCE -->
          <div id="paragraph-body" onclick="checkEssayPart('body', 'evidence')"
            class="mb-4 p-3 rounded-lg cursor-pointer hover:bg-teal-50 transition border-2 border-transparent">
            <p>When Tee battled Jayden, he didn't just yell louder or rhyme faster. He actually used the same steps we're supposed to use in our writing. Jayden said Tee "never wins at anything," but he didn't give any real proof. Tee pointed this out when he said, "You shouting loud, but you skipped every receipt you needed." That's evidence‚ÄîTee showed that Jayden's argument was weak because it had no facts backing it up.</p>
          </div>

          <!-- PARAGRAPH 3: COUNTERCLAIM -->
          <div id="paragraph-counterclaim" onclick="checkEssayPart('counterclaim', 'counterclaim')"
            class="mb-4 p-3 rounded-lg cursor-pointer hover:bg-rose-50 transition border-2 border-transparent">
            <p><strong>Some people think rap battles are too loud or inappropriate for school and shouldn't be used to teach writing.</strong> But this argument doesn't explain why something being loud means it can't teach real skills. When Tee answered Jayden, he showed that claims need proof. He repeated what Jayden said, pointed out what was missing, and then gave his own evidence. <strong>If students can learn argument structure from something they already care about, it makes the learning easier, not harder.</strong></p>
          </div>

          <!-- PARAGRAPH 4: CONCLUSION -->
          <div id="paragraph-conclusion" onclick="checkEssayPart('conclusion', 'conclusion')"
            class="mb-4 p-3 rounded-lg cursor-pointer hover:bg-green-50 transition border-2 border-transparent">
            <p><strong>Rap battles can teach students how to think like strong writers because they show argument structure in action.</strong> When I watched Tee at recess, I finally understood what a counterclaim was and how to address it. If we connect school to real life, everyone learns better.</p>
          </div>
        </div>
      </div>

      <!-- COMPLETION MESSAGE -->
      <div id="essayComplete" class="hidden mt-6 p-6 bg-green-100 border-2 border-green-600 rounded-xl">
        <p class="text-green-800 font-bold text-lg">üéâ Excellent! You found all the parts of Lee's argumentative essay!</p>
        <p class="text-green-700 mt-2">Now you know exactly where each element belongs. Time to write your own!</p>
      </div>
    </section>

    <div id="your-turn-write" class="anchor-target" aria-hidden="true"></div>
    <!-- OPEN-ENDED RESPONSE WITH RUBRIC (DOK 3) -->
    <section class="p-8 md:p-12 bg-white">
      <h2 class="font-display text-3xl font-bold mb-4 text-purple-700">Your Turn: Write a Response</h2>
      
      <div class="standard-tag mb-6">
        <span class="standard-code">CCSS.ELA.W.5.1</span>
        <span>Write opinion pieces with structured arguments</span>
      </div>
      
      <!-- SIOP Writing Scaffold - NEW -->
      <div class="word-bank mb-4">
        <p class="font-semibold text-purple-700 mb-2">üìù Writing Word Bank:</p>
        <div class="flex flex-wrap gap-1">
          <span class="bg-white px-2 py-1 rounded text-xs border">claim</span>
          <span class="bg-white px-2 py-1 rounded text-xs border">evidence</span>
          <span class="bg-white px-2 py-1 rounded text-xs border">counterclaim</span>
          <span class="bg-white px-2 py-1 rounded text-xs border">prove</span>
          <span class="bg-white px-2 py-1 rounded text-xs border">support</span>
          <span class="bg-white px-2 py-1 rounded text-xs border">explain</span>
          <span class="bg-white px-2 py-1 rounded text-xs border">therefore</span>
          <span class="bg-white px-2 py-1 rounded text-xs border">conclusion</span>
        </div>
      </div>

      <div class="bg-gradient-to-r from-amber-50 to-purple-50 p-6 rounded-xl mb-6">
        <h4 class="font-bold text-xl mb-3">Scenario:</h4>
        <p class="text-lg mb-4">Someone says: <strong>"Video games are just a waste of time. Kids who play them don't learn anything useful."</strong></p>
        <p class="text-lg mb-4">Use Tee's 4-step strategy to address this counterclaim. Defend video games (or choose your own position)!</p>

        <!-- NEW: Sentence Starters Bridge -->
        <div class="bg-white/80 p-4 rounded-lg mt-4">
          <p class="font-semibold text-purple-700 mb-2">üéØ Remember Tee's Strategy? Here's How to Start:</p>
          <div class="space-y-2 text-sm">
            <div class="flex items-start gap-2">
              <span class="bg-amber-100 text-amber-800 px-2 py-1 rounded font-bold text-xs">STEP 1</span>
              <span>Start with: <em>"You claim that video games are..."</em></span>
            </div>
            <div class="flex items-start gap-2">
              <span class="bg-teal-100 text-teal-800 px-2 py-1 rounded font-bold text-xs">STEP 2</span>
              <span>Then show evidence: <em>"However, research shows..." or "For example..."</em></span>
            </div>
            <div class="flex items-start gap-2">
              <span class="bg-purple-100 text-purple-800 px-2 py-1 rounded font-bold text-xs">STEP 3</span>
              <span>Explain: <em>"This proves your argument is wrong because..."</em></span>
            </div>
            <div class="flex items-start gap-2">
              <span class="bg-rose-100 text-rose-800 px-2 py-1 rounded font-bold text-xs">STEP 4</span>
              <span>Finish strong: <em>"Therefore, video games actually..."</em></span>
            </div>
          </div>
        </div>
      </div>

      <div class="grid md:grid-cols-3 gap-6">
        <div class="md:col-span-2">
          <div class="response-area">
            <label class="block font-semibold mb-2">Write your response:</label>
            <textarea 
              id="studentResponse" 
              class="response-textarea" 
              placeholder="Start with Step 1: State what they said...

Then Step 2: Show your evidence...

Step 3: Explain why they're wrong...

Finally, Step 4: Restate your position..."
              oninput="updateRubric()"
            ></textarea>
            
            <div class="flex gap-3 mt-4">
              <button onclick="saveResponse()" class="flex-1 bg-purple-600 text-white px-4 py-3 rounded-lg font-bold hover:bg-purple-700 transition">
                üíæ Save My Work
              </button>
              <button onclick="shareResponse()" class="flex-1 bg-teal-600 text-white px-4 py-3 rounded-lg font-bold hover:bg-teal-700 transition">
                üë• Share with Partner
              </button>
            </div>
          </div>
        </div>
        
        <div>
          <div class="bg-blue-50 p-4 rounded-xl">
            <h4 class="font-bold mb-3">Self-Check Rubric:</h4>
            <div class="space-y-2">
              <div class="rubric-item" id="rubric1">
                <input type="checkbox" class="rubric-checkbox" onchange="toggleRubricItem('rubric1')">
                <span class="text-sm">I stated what they said</span>
              </div>
              <div class="rubric-item" id="rubric2">
                <input type="checkbox" class="rubric-checkbox" onchange="toggleRubricItem('rubric2')">
                <span class="text-sm">I provided evidence</span>
              </div>
              <div class="rubric-item" id="rubric3">
                <input type="checkbox" class="rubric-checkbox" onchange="toggleRubricItem('rubric3')">
                <span class="text-sm">I explained why they're wrong</span>
              </div>
              <div class="rubric-item" id="rubric4">
                <input type="checkbox" class="rubric-checkbox" onchange="toggleRubricItem('rubric4')">
                <span class="text-sm">I restated my position</span>
              </div>
            </div>
            
            <div class="mt-4 p-3 bg-white rounded-lg text-sm">
              <strong>Tip:</strong> Check off each item as you include it in your response!
            </div>
          </div>
        </div>
      </div>
    </section>

    <div id="reflect-on-your-learning" class="anchor-target" aria-hidden="true"></div>
    <!-- REFLECTION & SEL INTEGRATION -->
    <section class="p-8 md:p-12 bg-gradient-to-b from-blue-50 to-purple-50" id="section-reflect">
      <h2 class="font-display text-3xl font-bold mb-4 text-purple-700" data-translate="reflection.title">Reflect on Your Learning</h2>

      <div class="space-y-6">
        <div class="bg-white p-6 rounded-xl">
          <h4 class="font-semibold mb-3" data-translate="reflection.question1">When have YOU had to address a counterclaim in real life?</h4>
          <textarea
            class="w-full p-4 border-2 border-gray-200 rounded-lg resize-none"
            rows="3"
            data-translate="reflection.placeholder1"
            placeholder="Maybe with a friend, family member, or teacher..."
          ></textarea>
        <div class="mt-2 flex gap-2">
        <button type="button" onclick="startDictation(this)"
                class="bg-blue-100 text-blue-700 px-3 py-1 rounded text-sm hover:bg-blue-200 transition" data-translate="buttons.speak_answer">
          üé§ Speak Answer
        </button>
        <button type="button" onclick="this.previousElementSibling.value=''"
                class="bg-gray-100 text-gray-700 px-3 py-1 rounded text-sm hover:bg-gray-200 transition" data-translate="buttons.clear">
          üóëÔ∏è Clear
        </button>
      </div>

        <div class="bg-white p-6 rounded-xl">
          <h4 class="font-semibold mb-3" data-translate="reflection.question2">What's the difference between arguing with facts vs. arguing with volume?</h4>
          <textarea
            class="w-full p-4 border-2 border-gray-200 rounded-lg resize-none"
            rows="3"
            data-translate="reflection.placeholder2"
            placeholder="Think about Tee's calm approach compared to how Jayden started..."
          ></textarea>
        <div class="mt-2 flex gap-2">
        <button type="button" onclick="startDictation(this)"
                class="bg-blue-100 text-blue-700 px-3 py-1 rounded text-sm hover:bg-blue-200 transition" data-translate="buttons.speak_answer">
          üé§ Speak Answer
        </button>
        <button type="button" onclick="this.previousElementSibling.value=''"
                class="bg-gray-100 text-gray-700 px-3 py-1 rounded text-sm hover:bg-gray-200 transition" data-translate="buttons.clear">
          üóëÔ∏è Clear
        </button>
      </div>

        <div class="bg-white p-6 rounded-xl">
          <h4 class="font-semibold mb-3" data-translate="reflection.question3">How are you feeling now after this lesson?</h4>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
            <button class="emotion-option" onclick="selectFinalEmotion(this, 'confident')">
              <div class="text-3xl">üí™</div>
              <div class="text-sm font-semibold" data-translate="reflection.confident">Confident</div>
            </button>
            <button class="emotion-option" onclick="selectFinalEmotion(this, 'curious')">
              <div class="text-3xl">ü§î</div>
              <div class="text-sm font-semibold" data-translate="reflection.curious">Curious</div>
            </button>
            <button class="emotion-option" onclick="selectFinalEmotion(this, 'ready')">
              <div class="text-3xl">üöÄ</div>
              <div class="text-sm font-semibold" data-translate="reflection.ready_emotion">Ready!</div>
            </button>
            <button class="emotion-option" onclick="selectFinalEmotion(this, 'unsure')">
              <div class="text-3xl">üòï</div>
              <div class="text-sm font-semibold" data-translate="reflection.still_unsure">Still Unsure</div>
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- LESSON COMPLETE -->
    <section class="p-8 md:p-12 text-center bg-gradient-to-b from-purple-600 to-purple-800 text-white">
      <div class="media-container mb-6" style="max-width: 300px; margin: 0 auto;">
        <img src="Gemini_Generated_Image_jhb8wijhb8wijhb8.png" alt="Tee walking away victoriously">
      </div>

      <div class="text-6xl mb-4">üéâ</div>
      <h2 class="font-display text-3xl font-bold mb-3" data-translate="ui.lesson_complete">Lesson Complete!</h2>
      <p class="text-purple-200 text-lg mb-6">You learned how to address a counterclaim using Tee's 4-step strategy.</p>

      <div class="bg-white/10 backdrop-blur rounded-xl p-6 max-w-md mx-auto mb-8">
        <p class="font-semibold text-amber-300 mb-2" data-translate="celebration.key_takeaway">üîë Key Takeaway:</p>
        <p class="text-xl font-display" data-translate="celebration.quote">"Loud is not the same as true."</p>
        <p class="text-purple-200 text-sm mt-2" data-translate="celebration.from_notebook">‚Äî From Lee's notebook</p>
      </div>

      <div id="finalScore" class="bg-white/20 backdrop-blur rounded-xl p-6 max-w-md mx-auto mb-8">
        <p class="text-2xl font-bold mb-2"><span data-translate="celebration.your_points">Your Learning Points:</span> <span id="finalPoints">0</span></p>
        <p class="text-purple-200 text-sm" data-translate="ui.great_work">Great work today!</p>
      </div>

      <div class="flex flex-wrap justify-center gap-4">
        <button onclick="window.location.reload()" class="bg-white text-purple-700 font-bold py-3 px-6 rounded-full hover:bg-purple-100 transition" data-translate="buttons.try_again">
          üìñ Try Again
        </button>
        <a href="episode2.html" class="bg-amber-400 text-amber-900 font-bold py-3 px-6 rounded-full hover:bg-amber-300 transition inline-block" data-translate="celebration.next_episode">
          ‚û°Ô∏è Next Episode
        </a>
      </div>
    </section>

    <!-- Skills Growth Visualizer -->
    <section class="mb-12">
      <div id="skills-visualizer"></div>
    </section>

    </div><!-- Close px wrapper -->
  </main>

 <script>
    // ===== FIXED: LEARNING PROGRESS TRACKING =====
    let learningState = {
      points: 0,
      badges: [],
      completedActivities: [],
      emotion: null,
      characterChoice: null,
      savedResponses: {}
    };
    
    let currentNarration = null;
    let isPlaying = false;
    let currentPlayback = null;
    let siopStrategiesVisible = false;
    let guidedStepsCompleted = 0;

    // GUIDED PRACTICE FUNCTION
    function checkGuidedStep(button, isCorrect, feedbackId) {
      const container = button.parentElement;
      const feedback = document.getElementById(feedbackId + '-feedback');

      // Remove previous styling
      container.querySelectorAll('button').forEach(btn => {
        btn.classList.remove('bg-green-100', 'bg-red-100', 'border-2', 'border-green-600');
      });

      if (isCorrect) {
        button.classList.add('bg-green-100', 'border-2', 'border-green-600');
        feedback.classList.remove('hidden');

        guidedStepsCompleted++;

        if (guidedStepsCompleted >= 3) {
          document.getElementById('guidedComplete').classList.remove('hidden');
        }
      } else {
        button.classList.add('bg-red-100');
        setTimeout(() => button.classList.remove('bg-red-100'), 500);
      }
    }

    // INTERACTIVE ESSAY FUNCTIONS
    let currentFinding = null;
    let essayPartsFound = 0;

    function highlightEssayPart(part) {
      currentFinding = part;

      // Reset all paragraphs
      const allParagraphs = ['paragraph-intro', 'paragraph-body', 'paragraph-counterclaim', 'paragraph-conclusion'];
      allParagraphs.forEach(id => {
        const para = document.getElementById(id);
        para.classList.remove('border-purple-600', 'border-teal-600', 'border-rose-600', 'border-green-600', 'bg-purple-50', 'bg-teal-50', 'bg-rose-50', 'bg-green-50');
        para.classList.add('border-transparent');
      });

      // Update button states
      const allButtons = ['btn-claim', 'btn-evidence', 'btn-counterclaim', 'btn-conclusion'];
      allButtons.forEach(id => {
        const btn = document.getElementById(id);
        btn.classList.remove('opacity-50', 'ring-4', 'ring-purple-300');
      });

      // Highlight active button
      const activeButton = document.getElementById('btn-' + part);
      activeButton.classList.add('ring-4', 'ring-purple-300');

      // Update instruction
      const instruction = document.getElementById('essay-instruction');
      const partNames = {
        'claim': 'the CLAIM',
        'evidence': 'the EVIDENCE',
        'counterclaim': 'the COUNTERCLAIM',
        'conclusion': 'the CONCLUSION'
      };
      instruction.textContent = 'üëá Now click the paragraph that contains ' + partNames[part] + '!';
    }

    function checkEssayPart(paragraphId, correctPart) {
      if (!currentFinding) {
        return; // No part selected yet
      }

      const paragraph = document.getElementById('paragraph-' + paragraphId);
      const button = document.getElementById('btn-' + currentFinding);
      const instruction = document.getElementById('essay-instruction');

      if (currentFinding === correctPart) {
        // CORRECT!
        const colors = {
          'claim': { border: 'border-purple-600', bg: 'bg-purple-50' },
          'evidence': { border: 'border-teal-600', bg: 'bg-teal-50' },
          'counterclaim': { border: 'border-rose-600', bg: 'bg-rose-50' },
          'conclusion': { border: 'border-green-600', bg: 'bg-green-50' }
        };

        paragraph.classList.remove('border-transparent');
        paragraph.classList.add(colors[correctPart].border, colors[correctPart].bg);

        // Mark button as completed
        button.disabled = true;
        button.classList.add('opacity-50');
        button.classList.remove('ring-4', 'ring-purple-300');
        const foundPrefix = typeof translator !== 'undefined'
          ? translator.t('essay_hunt.found_prefix', '‚úì Found')
          : '‚úì Found';
        const partName = button.dataset.partName
          ? (typeof translator !== 'undefined'
              ? translator.t(`vocab.${button.dataset.partName.toLowerCase()}`, button.dataset.partName)
              : button.dataset.partName)
          : button.textContent.trim();
        button.textContent = `${foundPrefix} ${partName}`;

        essayPartsFound++;

        if (essayPartsFound >= 4) {
          // ALL FOUND!
          instruction.textContent = typeof translator !== 'undefined'
            ? translator.t('essay_hunt.perfect', 'üéâ Perfect! You found all four parts!')
            : 'üéâ Perfect! You found all four parts!';
          document.getElementById('essayComplete').classList.remove('hidden');
          updatePoints(20, 'Identified all essay parts!');
        } else {
          instruction.textContent = typeof translator !== 'undefined'
            ? translator.t('essay_hunt.continue', '‚úì Correct! Click another button to continue.')
            : '‚úì Correct! Click another button to continue.';
        }

        currentFinding = null;

      } else {
        // WRONG - shake animation
        paragraph.style.animation = 'shake 0.3s';
        setTimeout(() => { paragraph.style.animation = ''; }, 300);
        instruction.textContent = typeof translator !== 'undefined'
          ? translator.t('essay_hunt.not_quite', '‚ùå Not quite. Try again!')
          : '‚ùå Not quite. Try again!';
      }
    }

    // FIXED: Load saved progress - but reset if empty
    function loadProgress() {
      const saved = localStorage.getItem('leeTeeLessonProgress');
      if (saved) {
        try {
          learningState = JSON.parse(saved);
          // Ensure we don't have prefilled progress
          if (learningState.completedActivities.length > 0) {
            // Keep only emotional and character choices if user wants
            learningState.completedActivities = learningState.completedActivities.filter(
              activity => activity === 'sel' || activity === 'character'
            );
          }
        } catch (e) {
          console.error('Error loading progress:', e);
          resetProgress();
        }
      } else {
        // Initialize fresh state
        learningState = {
          points: 0,
          badges: [],
          completedActivities: [],
          emotion: null,
          characterChoice: null,
          savedResponses: {}
        };
      }
      
      const pointsDisplay = document.getElementById('pointsDisplay');
      if (pointsDisplay) pointsDisplay.textContent = learningState.points;

      const finalPoints = document.getElementById('finalPoints');
      if (finalPoints) finalPoints.textContent = learningState.points;

      updateBadges();
      
      // FIXED: Only restore checkmarks for SEL and character choice
      learningState.completedActivities.forEach(activity => {
        const element = document.getElementById(`progress-${activity}`);
        if (element) {
          element.textContent = '‚úÖ';
          element.classList.add('completed');
        }
      });

      updateProgressPercentage();
      updateProgressChecklist(); // Update left rail checklist
    }

    // NEW FUNCTION: Reset all progress
    function resetProgress() {
      if (confirm('Are you sure you want to reset all progress? This will clear all points and completed activities.')) {
        localStorage.removeItem('leeTeeLessonProgress');
        learningState = {
          points: 0,
          badges: [],
          completedActivities: [],
          emotion: null,
          characterChoice: null,
          savedResponses: {}
        };
        
        // Reset UI
        document.getElementById('pointsDisplay').textContent = '0';
        document.getElementById('finalPoints').textContent = '0';
        
        // Reset all progress checkmarks
        document.querySelectorAll('.progress-check').forEach(el => {
          el.textContent = '‚óª';
          el.classList.remove('completed');
        });
        
        // Reset badges
        document.getElementById('badgeContainer').innerHTML = '';
        
        updateProgressPercentage();
        alert('Progress reset! Starting fresh.');
      }
    }

    // Update the percentage display
    function updateProgressPercentage() {
      const totalChecks = document.querySelectorAll('.progress-check').length;
      const completed = document.querySelectorAll('.progress-check.completed').length;
      const percentage = Math.round((completed / totalChecks) * 100);
      const percentEl = document.getElementById('progress-percentage');
      if (percentEl) percentEl.textContent = `${percentage}%`;

      // Update left rail checklist
      updateProgressChecklist();
    }

    // Save progress
    function saveProgress() {
      localStorage.setItem('leeTeeLessonProgress', JSON.stringify(learningState));
    }

    // ===== GAMIFICATION SYSTEM =====
    function addPoints(amount, reason) {
      learningState.points += amount;

      // Also update global state
      if (typeof addGlobalPoints === 'function') {
        addGlobalPoints(1, amount, reason);
      }
      document.getElementById('pointsDisplay').textContent = learningState.points;
      document.getElementById('finalPoints').textContent = learningState.points;
      saveProgress();
      
      // Show celebration
      celebrate(amount, reason);
      
      // Create confetti
      createConfetti();
    }

    function celebrate(points, reason) {
      const overlay = document.getElementById('celebrationOverlay');
      document.getElementById('celebrationEmoji').textContent = points >= 25 ? 'üéâ' : '‚≠ê';
      document.getElementById('celebrationTitle').textContent = reason;
      document.getElementById('celebrationMessage').textContent = `+${points} points!`;
      overlay.classList.add('show');
      
      setTimeout(() => {
        overlay.classList.remove('show');
      }, 3000);
    }

    function closeCelebration() {
      document.getElementById('celebrationOverlay').classList.remove('show');
    }

    function createConfetti() {
      const colors = ['#7C3AED', '#F59E0B', '#0D9488', '#E11D48'];
      for (let i = 0; i < 20; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = Math.random() * 100 + 'vw';
        confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.animationDelay = Math.random() * 0.5 + 's';
        document.body.appendChild(confetti);
        
        setTimeout(() => confetti.remove(), 3000);
      }
    }

    function awardBadge(badge) {
      if (!learningState.badges.includes(badge)) {
        learningState.badges.push(badge);
        updateBadges();
        saveProgress();
      }
    }

    function updateBadges() {
       const container = document.getElementById('badgeContainer');
       if (!container) return;
       container.innerHTML = '';

      learningState.badges.forEach(badge => {
        const badgeEl = document.createElement('div');
        badgeEl.className = 'text-2xl badge-earned';
        badgeEl.textContent = badge;
        badgeEl.title = getBadgeName(badge);
        container.appendChild(badgeEl);
      });
    }

    function getBadgeName(emoji) {
      const badges = {
        'üéØ': 'Vocab Master',
        'üß†': 'Critical Thinker',
        '‚úçÔ∏è': 'Response Writer',
        'üé§': 'Strategy Expert',
        'üèÜ': 'Lesson Complete'
      };
      return badges[emoji] || 'Badge Earned';
    }

    // ===== SEL CHECK-IN =====
    function selectEmotion(element, emotion) {
      document.querySelectorAll('.emotion-option').forEach(el => {
        el.classList.remove('selected');
      });
      element.classList.add('selected');
      learningState.emotion = emotion;
      saveProgress();

      // Mark progress
      const progressElement = document.getElementById('progress-sel');
      if (progressElement && !progressElement.classList.contains('completed')) {
        progressElement.textContent = '‚úÖ';
        progressElement.classList.add('completed');
        learningState.completedActivities.push('sel');
        saveProgress();
        updateProgressPercentage();
      }

      // Show simple feedback message
      const feedback = document.getElementById('selFeedback');
      if (feedback) {
        let message = '';
        if (emotion === 'tired') {
          message = 'üíô Got it! Audio features are available to help you follow along.';
        } else if (emotion === 'nervous') {
          message = 'üíú No worries! Extra help features are available in the settings menu.';
        } else if (emotion === 'excited') {
          message = 'üéâ Love the energy! Let\'s dive in!';
        } else if (emotion === 'calm') {
          message = 'üåü Perfect mindset for learning. Let\'s get started!';
        }

        feedback.textContent = message;
        feedback.classList.remove('hidden');
        // Message stays visible permanently
      }
    }

    function selectFinalEmotion(element, emotion) {
      document.querySelectorAll('.emotion-option').forEach(el => {
        el.classList.remove('selected');
      });
      element.classList.add('selected');
    }

    // ===== CHARACTER CHOICE =====
    function chooseCharacter(character) {
      document.querySelectorAll('.choice-card').forEach(card => {
        card.classList.remove('selected');
      });
      
      const selectedCard = document.getElementById('choose' + character.charAt(0).toUpperCase() + character.slice(1));
      selectedCard.classList.add('selected');
      
      learningState.characterChoice = character;
      learningState.completedActivities.push('character');
      saveProgress();
      
      document.getElementById('characterFeedback').classList.remove('hidden');
      addPoints(5, 'Great choice!');
    }

    // ===== VOCABULARY DATA ====
    const vocabData = {
      claim: {
        word: 'Claim',
        def: 'What you believe or what you are trying to prove. It\'s your main point.',
        example: 'Jayden made a claim that Tee "never wins at anything."',
        spanish: 'En espa√±ol: afirmaci√≥n',
        image: 'üì¢'
      },
      evidence: {
        word: 'Evidence',
        def: 'Proof or facts that support your claim. Also called "receipts."',
        example: 'Tee brought evidence: "Ms. R checked attendance... I been on-time all quarter."',
        spanish: 'En espa√±ol: evidencia, prueba',
        image: 'üìÑ'
      },
      counterclaim: {
        word: 'Counterclaim',
        def: 'The other side\'s argument. Addressing a counterclaim means explaining why the opposing view is weak.',
        example: 'Lee learned to address a counterclaim by watching Tee respond to Jayden\'s argument.',
        spanish: 'En espa√±ol: contraargumento',
        image: '‚Üî'
      }
    };

    // ===== VOCABULARY ACTIVITIES =====
    function showVocab(word) {
      // STOP any current narration
      if (currentNarration) {
        speechSynthesis.cancel();
        currentNarration = null;
        isPlaying = false;
      }
      
      const data = vocabData[word];
      document.getElementById('vocabWord').textContent = data.word;
      document.getElementById('vocabDef').textContent = data.def;
      document.getElementById('vocabExample').textContent = data.example;
      document.getElementById('vocabSpanish').textContent = data.spanish;
      document.getElementById('vocabImage').textContent = data.image;
      document.getElementById('vocabModal').classList.add('open');
    }

    function closeVocabModal(e) {
      if (e.target.classList.contains('vocab-modal')) {
        document.getElementById('vocabModal').classList.remove('open');
        
        // STOP any current narration
        if (currentNarration) {
          speechSynthesis.cancel();
          currentNarration = null;
          isPlaying = false;
        }
      }
    }

    function speakWord() {
      // Stop any existing narration
      if (currentNarration) {
        speechSynthesis.cancel();
      }
      
      const pickVoice = () => {
  const voices = speechSynthesis.getVoices();
  return voices.find(v => v.name === 'Google US English')
    || voices.find(v => v.lang === 'en-US')
    || voices[0];
};

utterance.voice = pickVoice();
utterance.lang = utterance.voice?.lang || 'en-US';

      utterance.rate = 0.9;
      
      // Store the current narration
      currentNarration = utterance;
      
      // Clear narration when done
      utterance.onend = () => {
        currentNarration = null;
        isPlaying = false;
      };
      
      utterance.onerror = () => {
        currentNarration = null;
        isPlaying = false;
      };
      
     speechSynthesis.cancel(); // stop any previous voice

  const speakNow = () => {
  const voices = speechSynthesis.getVoices();
  const v =
  voices.find(x => x.name === "Google US English") ||
  voices.find(x => x.lang === "en-US") || voices[0];

  if (v) {
    utterance.voice = v;
    utterance.lang = 'en-US';
  }
  console.log('VOICE USED:', utterance.voice?.name, 'LANG:', utterance.lang);
  speechSynthesis.speak(utterance);
};

if (speechSynthesis.getVoices().length) {
  speakNow();
} else {
  speechSynthesis.onvoiceschanged = () => speakNow();
}

    }

    function showVocabChoices(blankId, correctWord) {
      // Close all other choice menus
      document.querySelectorAll('.vocab-choices').forEach(menu => {
        menu.classList.remove('show');
      });
      
      // Show this one
      const choicesId = blankId.replace('blank', 'choices');
      document.getElementById(choicesId).classList.add('show');
    }

    function checkVocabChoice(blankId, choicesId, selectedWord, isCorrect) {
      const choices = document.getElementById(choicesId);
      const blank = document.getElementById(blankId);
      const feedbackId = blankId.replace('blank', 'feedback');
      
      // Hide choices
      choices.classList.remove('show');
      
      if (isCorrect) {
        blank.textContent = selectedWord;
        blank.classList.add('text-green-700', 'font-bold');
        document.getElementById(feedbackId).classList.remove('hidden');
        
        // Award points
        if (!learningState.completedActivities.includes(blankId)) {
          learningState.completedActivities.push(blankId);
          addPoints(10, 'Vocab correct!');
          
          // Check if all vocab done (all 3 blanks)
          const vocabCompleted = ['blank1', 'blank2', 'blank3'].every(id => 
            learningState.completedActivities.includes(id)
          );
          
          if (vocabCompleted) {
            // Mark progress tracker
            const progressElement = document.getElementById('progress-vocab');
            if (progressElement && !progressElement.classList.contains('completed')) {
              progressElement.textContent = '‚úÖ';
              progressElement.classList.add('completed');
              learningState.completedActivities.push('vocab');
              updateProgressPercentage();
            }
            awardBadge('üéØ');
          }
        }
      } else {
        // Incorrect feedback
        blank.style.background = '#FEE2E2';
        setTimeout(() => {
          blank.style.background = '';
        }, 500);
      }
      
      saveProgress();
    }

    // ===== SIMPLE BUT EFFECTIVE HIGHLIGHTING SYSTEM =====
    
    // 1. LISTEN MODE - Highlight sentences
    function toggleSectionAudio(btn, sectionId) {
        const floatingBtn = document.getElementById('floatingStopBtn');

        if (btn.classList.contains('playing')) {
            // Stop playback
            speechSynthesis.cancel();
            btn.classList.remove('playing');
            btn.textContent = 'üîä Listen';
            removeAllHighlights();

            // Hide floating stop button
            if (floatingBtn) floatingBtn.classList.remove('active');
        } else {
            // Stop any existing playback
            speechSynthesis.cancel();
            document.querySelectorAll('.playing').forEach(b => {
                b.classList.remove('playing');
                b.textContent = 'üîä Listen';
            });

            // Start playback
            btn.classList.add('playing');
            btn.textContent = '‚èπÔ∏è Stop';

            // Show floating stop button
            if (floatingBtn) floatingBtn.classList.add('active');

            startSentencePlayback(sectionId, btn);
        }
    }
    
    // 2. READ ALOUD MODE - Highlight words
    function readAloudWithWordHighlight(btn, sectionId) {
        const floatingBtn = document.getElementById('floatingStopBtn');

        if (btn.classList.contains('btn-playing')) {
            // Stop playback
            speechSynthesis.cancel();
            btn.classList.remove('btn-playing');
            btn.innerHTML = '<span>üéôÔ∏è</span><span>Read Aloud</span>';
            removeAllHighlights();

            // Hide floating stop button
            if (floatingBtn) floatingBtn.classList.remove('active');
        } else {
            // Stop any existing playback
            speechSynthesis.cancel();
            document.querySelectorAll('.btn-playing').forEach(b => {
                b.classList.remove('btn-playing');
                b.innerHTML = '<span>üéôÔ∏è</span><span>Read Aloud</span>';
            });

            // Start playback
            btn.classList.add('btn-playing');
            btn.innerHTML = '<span>‚èπÔ∏è</span><span>Stop</span>';

            // Show floating stop button
            if (floatingBtn) floatingBtn.classList.add('active');

            startWordPlayback(sectionId, btn);
        }
    }

    // Stop all narration (called by floating button)
    function stopAllNarration() {
        speechSynthesis.cancel();
        document.querySelectorAll('.btn-playing').forEach(b => {
            b.classList.remove('btn-playing');
            b.innerHTML = '<span>üéôÔ∏è</span><span>Read Aloud</span>';
        });
        document.querySelectorAll('.playing').forEach(b => {
            b.classList.remove('playing');
            b.textContent = 'üîä Listen';
        });
        removeAllHighlights();

        const floatingBtn = document.getElementById('floatingStopBtn');
        if (floatingBtn) floatingBtn.classList.remove('active');
    }
    
    // 3. SENTENCE PLAYBACK
    function startSentencePlayback(sectionId, btn) {
        const section = document.getElementById(sectionId);
        if (!section) return;
        
        const storyText = section.querySelector('.story-text');
        if (!storyText) return;
        
        // Save original state
        if (!storyText.dataset.original) {
            storyText.dataset.original = storyText.innerHTML;
        }
        
        // Get paragraphs and speech bubbles
        const paragraphs = storyText.querySelectorAll('p');
        const speechBubbles = storyText.querySelectorAll('.speech-bubble p:not(:first-child)');
        
        let allSentences = [];
        paragraphs.forEach(p => {
            if (!p.parentElement.classList.contains('speech-bubble') || 
                (p.parentElement.classList.contains('speech-bubble') && !p.previousElementSibling)) {
                allSentences.push(p);
            }
        });
        speechBubbles.forEach(p => allSentences.push(p));
        
        // Create combined text
        let fullText = '';
        allSentences.forEach((p, i) => {
            p.dataset.sentenceIndex = i;
            fullText += p.textContent + ' ';
        });
        
        // Create utterance
        const utterance = new SpeechSynthesisUtterance(fullText);
        utterance.rate = 0.85;
        
        utterance.onboundary = (event) => {
            if (event.name === 'sentence' || event.name === 'word') {
                // Find current sentence based on character index
                let charCount = 0;
                let currentSentence = null;
                
                for (let i = 0; i < allSentences.length; i++) {
                    const sentence = allSentences[i];
                    const textLength = sentence.textContent.length;
                    
                    if (event.charIndex >= charCount && event.charIndex < charCount + textLength) {
                        currentSentence = sentence;
                        break;
                    }
                    charCount += textLength + 1; // +1 for space
                }
                
                if (currentSentence) {
                    // Remove previous highlights
                    allSentences.forEach(s => {
                        s.classList.remove('active-sentence');
                        s.style.backgroundColor = '';
                    });
                    
                    // Add highlight
                    currentSentence.classList.add('active-sentence');
                    currentSentence.style.backgroundColor = 'rgba(253, 230, 138, 0.5)';
                    currentSentence.style.padding = '8px 12px';
                    currentSentence.style.margin = '8px 0';
                    currentSentence.style.borderRadius = '4px';
                    currentSentence.style.borderLeft = '3px solid #7C3AED';
                    currentSentence.style.borderRight = '3px solid #7C3AED';

                    // Gentle scroll - only if sentence is off-screen
                    const rect = currentSentence.getBoundingClientRect();
                    const isOffScreen = (rect.bottom < 0 || rect.top > window.innerHeight);

                    if (isOffScreen) {
                        currentSentence.scrollIntoView({
                            behavior: 'auto',
                            block: 'nearest'
                        });
                    }
                }
            }
        };
        
        utterance.onend = () => {
            btn.classList.remove('playing');
            btn.textContent = 'üîä Listen';
            removeAllHighlights();
            if (storyText.dataset.original) {
                storyText.innerHTML = storyText.dataset.original;
                delete storyText.dataset.original;
            }
        };
        
        utterance.onerror = () => {
            btn.classList.remove('playing');
            btn.textContent = 'üîä Listen';
            removeAllHighlights();
            if (storyText.dataset.original) {
                storyText.innerHTML = storyText.dataset.original;
                delete storyText.dataset.original;
            }
        };
        
        speechSynthesis.speak(utterance);
    }
    
    // 4. WORD PLAYBACK
    function startWordPlayback(sectionId, btn) {
        const section = document.getElementById(sectionId);
        if (!section) return;

        const storyText = section.querySelector('.story-text');
        if (!storyText) return;

        // Save original state
        if (!storyText.dataset.original) {
            storyText.dataset.original = storyText.innerHTML;
        }

        // Get all paragraphs to wrap
        const paragraphs = storyText.querySelectorAll('p');
        const allWordSpans = [];

        paragraphs.forEach(p => {
            // Skip character names in speech bubbles
            if (p.classList.contains('font-bold') && p.parentElement.classList.contains('speech-bubble')) {
                return;
            }

            // Function to wrap text nodes in spans
            function wrapTextNodes(node) {
                if (node.nodeType === Node.TEXT_NODE) {
                    const text = node.textContent;
                    if (text.trim().length === 0) return;

                    // Split into words
                    const words = text.split(/(\s+)/);
                    const fragment = document.createDocumentFragment();

                    words.forEach(word => {
                        if (word.trim().length > 0) {
                            const span = document.createElement('span');
                            span.className = 'word-highlight';
                            span.textContent = word;
                            allWordSpans.push(span);
                            fragment.appendChild(span);
                        } else if (word.length > 0) {
                            // Preserve whitespace
                            fragment.appendChild(document.createTextNode(word));
                        }
                    });

                    node.replaceWith(fragment);
                } else if (node.nodeType === Node.ELEMENT_NODE) {
                    // Skip certain elements
                    if (node.classList && (node.classList.contains('vocab-word') || node.tagName === 'BUTTON')) {
                        return;
                    }
                    // Recursively process child nodes
                    Array.from(node.childNodes).forEach(child => wrapTextNodes(child));
                }
            }

            // Clone the paragraph to avoid modifying during iteration
            const clone = p.cloneNode(true);
            wrapTextNodes(clone);
            p.innerHTML = clone.innerHTML;
        });

        // Get all word spans after wrapping
        const wordSpans = storyText.querySelectorAll('.word-highlight');

        // Create clean text for speech
        const cleanText = Array.from(wordSpans).map(span => span.textContent).join(' ');

        // Create utterance
        const utterance = new SpeechSynthesisUtterance(cleanText);
        utterance.rate = 0.85;
        utterance.pitch = 0.9;


        let currentWordIdx = 0;
        let boundaryFired = false;
        let fallbackTimer = null;
        let startTime = null;

        // Helper function to highlight a word
        function highlightWord(index) {
            // Remove previous highlights
            wordSpans.forEach(span => {
                span.classList.remove('active-word');
            });

            // Highlight current word
            if (index < wordSpans.length) {
                const currentWord = wordSpans[index];
                currentWord.classList.add('active-word');

                // Very gentle scroll - only if word is truly off-screen
                // Give users more control by only scrolling when necessary
                const rect = currentWord.getBoundingClientRect();
                const topBuffer = 150;  // Increased buffer zone
                const bottomBuffer = 200;  // Larger bottom buffer for mobile keyboards
                const isVisible = (
                    rect.top >= topBuffer &&
                    rect.bottom <= (window.innerHeight - bottomBuffer)
                );

                // Only scroll if word is completely off-screen
                if (!isVisible && (rect.bottom < 0 || rect.top > window.innerHeight)) {
                    currentWord.scrollIntoView({
                        behavior: 'auto',  // Changed from 'smooth' to 'auto' for less interruption
                        block: 'nearest',
                        inline: 'nearest'
                    });
                }
            }
        }

        // Try to use word boundaries (most accurate)
        utterance.onboundary = (event) => {
            if (event.name === 'word') {
                boundaryFired = true;

                // Cancel fallback if word boundaries are working
                if (fallbackTimer) {
                    clearTimeout(fallbackTimer);
                    fallbackTimer = null;
                }

                highlightWord(currentWordIdx);
                currentWordIdx++;
            }
        };

        // Fallback: Dynamic timing-based highlighting
        utterance.onstart = () => {
            startTime = Date.now();

            // Wait to see if word boundaries fire
            setTimeout(() => {
                if (!boundaryFired && speechSynthesis.speaking) {
                    console.log('Word boundaries not supported, using dynamic timing fallback');
                    currentWordIdx = 0;
                    highlightNextWord();
                }
            }, 100);
        };

        function highlightNextWord() {
            if (currentWordIdx >= wordSpans.length || !speechSynthesis.speaking) {
                return;
            }

            highlightWord(currentWordIdx);

            // Calculate dynamic delay based on word length and speech rate
            const word = wordSpans[currentWordIdx].textContent;
            const wordLength = word.length;

            // Base duration calculation - OPTIMIZED timing
            // Using 165 WPM for balanced speed (between 150-too slow and 180-too fast)
            const baseWordDuration = 60000 / (utterance.rate * 165); // ~404ms

            // Adjust based on word length (longer words take more time)
            // Average English word is ~5 characters
            const lengthFactor = wordLength / 5;
            const adjustedDuration = baseWordDuration * (0.6 + (lengthFactor * 0.4));

            // Moderate pause for punctuation
            const hasPunctuation = /[.,!?;:]/.test(word);
            const punctuationPause = hasPunctuation ? 100 : 0;

            const totalDuration = adjustedDuration + punctuationPause;

            currentWordIdx++;
            fallbackTimer = setTimeout(highlightNextWord, totalDuration);
        }

        utterance.onend = () => {
            clearTimeout(fallbackTimer);
            btn.classList.remove('btn-playing');
            btn.innerHTML = '<span>üéôÔ∏è</span><span>Read Aloud</span>';
            removeAllHighlights();
            if (storyText.dataset.original) {
                storyText.innerHTML = storyText.dataset.original;
                delete storyText.dataset.original;
            }
        };

        utterance.onerror = () => {
            clearTimeout(fallbackTimer);
            btn.classList.remove('btn-playing');
            btn.innerHTML = '<span>üéôÔ∏è</span><span>Read Aloud</span>';
            removeAllHighlights();
            if (storyText.dataset.original) {
                storyText.innerHTML = storyText.dataset.original;
                delete storyText.dataset.original;
            }
        };

        speechSynthesis.speak(utterance);
    }
    
    // 5. REMOVE ALL HIGHLIGHTS
    function removeAllHighlights() {
        document.querySelectorAll('.active-sentence, .active-word').forEach(el => {
            el.classList.remove('active-sentence', 'active-word');
            el.style.backgroundColor = '';
            el.style.padding = '';
            el.style.margin = '';
            el.style.borderRadius = '';
            el.style.borderLeft = '';
            el.style.borderRight = '';
        });
    }

    // ===== PROBLEM ANALYSIS =====
    function checkProblemAnswers() {
      const checkboxes = document.querySelectorAll('.problem-check');
      let allCorrect = true;
      let correctCount = 0;
      let incorrectCount = 0;

      checkboxes.forEach(checkbox => {
        const isCorrect = checkbox.dataset.correct === 'true';
        const isChecked = checkbox.checked;

        if (isCorrect && isChecked) {
          correctCount++;
        }

        if (!isCorrect && isChecked) {
          incorrectCount++;
        }

        if ((isCorrect && !isChecked) || (!isCorrect && isChecked)) {
          allCorrect = false;
        }
      });

      if (allCorrect) {
        document.getElementById('problemFeedback').classList.remove('hidden');
        if (!learningState.completedActivities.includes('problemAnalysis')) {
          learningState.completedActivities.push('problemAnalysis');
          addPoints(15, translator.t('rewards.critical_thinking', 'Critical thinking!'));
          awardBadge('üß†');
        }
      } else {
        // Better feedback based on what they got wrong
        let message = translator.t('feedback.problem_not_quite', 'Not quite! ');

        if (incorrectCount > 0) {
          message += translator.t('feedback.problem_behavior', "Remember: we're looking for what makes the ARGUMENT weak, not just behavior issues. ");
        }

        if (correctCount < 2) {
          message += translator.t('feedback.problem_two_answers', 'There are TWO correct answers - make sure you select both!');
        }

        alert(message);
      }

      saveProgress();
    }

    // ===== QUIZ/CHECK FUNCTIONS ====
    function checkAnswer(btn, correct, id) {
      const container = btn.parentElement;
      container.querySelectorAll('.quiz-option').forEach(b => {
        b.classList.remove('selected', 'correct', 'incorrect');
      });
      
      if (correct) {
        btn.classList.add('correct');
        document.getElementById(id + '-feedback').classList.remove('hidden');
        
        // Mark section progress based on which quiz
        if (id === 'comp1') {
          const progressElement = document.getElementById('progress-section1');
          if (progressElement && !progressElement.classList.contains('completed')) {
            progressElement.textContent = '‚úÖ';
            progressElement.classList.add('completed');
            learningState.completedActivities.push('section1');
            updateProgressPercentage();
          }
        } else if (id === 'comp2') {
          const progressElement = document.getElementById('progress-section2');
          if (progressElement && !progressElement.classList.contains('completed')) {
            progressElement.textContent = '‚úÖ';
            progressElement.classList.add('completed');
            learningState.completedActivities.push('section2');
            updateProgressPercentage();
          }
        }
      } else {
        btn.classList.add('incorrect');
      }
    }

    // ===== DRAG AND DROP =====
    let draggedItem = null;
    let correctPlacements = 0;

    // Add drag listeners on load
    document.addEventListener('DOMContentLoaded', () => {
      const rapLines = document.querySelectorAll('.rap-line');
      rapLines.forEach(line => {
        line.addEventListener('dragstart', dragStart);
        line.addEventListener('dragend', dragEnd);
      });
      
      // Initialize progress
      loadProgress();
    });

    function dragStart(e) {
      draggedItem = e.target;
      e.target.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', e.target.dataset.step);
    }

    function dragEnd(e) {
      e.target.classList.remove('dragging');
    }

    function dragOver(e) {
      e.preventDefault();
      e.currentTarget.classList.add('drag-over');
    }

    function dragLeave(e) {
      e.currentTarget.classList.remove('drag-over');
    }

    function drop(e) {
      e.preventDefault();
      const dropZone = e.currentTarget;
      dropZone.classList.remove('drag-over');
      
      const targetStep = dropZone.dataset.target;
      const itemStep = draggedItem.dataset.step;
      
      if (targetStep === itemStep) {
        // Correct!
        dropZone.innerHTML = '';
        const clone = draggedItem.cloneNode(true);
        clone.classList.add('correct');
        clone.draggable = false;
        dropZone.appendChild(clone);
        dropZone.classList.add('filled');
        
        draggedItem.style.display = 'none';
        correctPlacements++;
        
        if (correctPlacements >= 4) {
          document.getElementById('strategyFeedback').classList.remove('hidden');
          if (!learningState.completedActivities.includes('dragDrop')) {
            learningState.completedActivities.push('dragDrop');
            addPoints(25, 'Strategy mastered!');
            awardBadge('üé§');
            
            // Mark progress tracker
            const progressElement = document.getElementById('progress-drag');
            if (progressElement && !progressElement.classList.contains('completed')) {
              progressElement.textContent = '‚úÖ';
              progressElement.classList.add('completed');
              learningState.completedActivities.push('drag');
              updateProgressPercentage();
            }
          }
        }
      } else {
        // Incorrect - shake animation
        draggedItem.classList.add('incorrect');
        setTimeout(() => draggedItem.classList.remove('incorrect'), 300);
      }
      
      saveProgress();
    }

    // ===== OPEN-ENDED RESPONSE =====
    function toggleRubricItem(itemId) {
      const item = document.getElementById(itemId);
      const checkbox = item.querySelector('input');
      if (checkbox.checked) {
        item.classList.add('checked');
      } else {
        item.classList.remove('checked');
      }
    }

    function updateRubric() {
      // Auto-check rubric based on text content (simplified)
      const text = document.getElementById('studentResponse').value.toLowerCase();
      const rubricItems = document.querySelectorAll('.rubric-item');
      
      rubricItems.forEach((item, index) => {
        const checkbox = item.querySelector('input');
        let isIncluded = false;
        
        if (index === 0 && (text.includes('they said') || text.includes('you claim') || text.includes('argument is'))) {
          isIncluded = true;
        } else if (index === 1 && (text.includes('evidence') || text.includes('proof') || text.includes('facts') || text.includes('research') || text.includes('study'))) {
          isIncluded = true;
        } else if (index === 2 && (text.includes('wrong') || text.includes('incorrect') || text.includes('mistaken') || text.includes('however') || text.includes('but'))) {
          isIncluded = true;
        } else if (index === 3 && (text.includes('conclusion') || text.includes('therefore') || text.includes('position') || text.includes('believe') || text.includes('think'))) {
          isIncluded = true;
        }
        
        checkbox.checked = isIncluded;
        toggleRubricItem(item.id);
      });
    }

    function saveResponse() {
      const response = document.getElementById('studentResponse').value;
      if (response.trim().length < 50) {
        alert('Try writing a bit more! Use all 4 steps of Tee\'s strategy.');
        return;
      }
      
      learningState.savedResponses.videoGames = response;
      saveProgress();
      
      if (!learningState.completedActivities.includes('openResponse')) {
        learningState.completedActivities.push('openResponse');
        addPoints(30, 'Response written!');
        awardBadge('‚úçÔ∏è');
        
        // Mark progress tracker
        const progressElement = document.getElementById('progress-essay');
        if (progressElement && !progressElement.classList.contains('completed')) {
          progressElement.textContent = '‚úÖ';
          progressElement.classList.add('completed');
          learningState.completedActivities.push('essay');
          updateProgressPercentage();
        }
      }
      
      alert('üíæ Your response has been saved!');
    }

    function shareResponse() {
      const response = document.getElementById('studentResponse').value;
      if (response.trim().length < 50) {
        alert('Write your response first, then you can share with a partner!');
        return;
      }
      
      alert('ü§ù Great! Now share your screen or read your response to your partner. Ask them:\n\n1. Did I use all 4 steps?\n2. Was my evidence strong?\n3. What could make it better?');
    }

    // ===== HELPER MODALS ====
    function openHelper(character) {
      document.getElementById(character + '-modal').classList.add('open');
    }

    function closeHelper(e, character) {
      if (e.target.classList.contains('helper-modal')) {
        document.getElementById(character + '-modal').classList.remove('open');
      }
    }

    // ===== CONTEXTUAL HELPER SYSTEM =====
    let helperTimers = {};
    let helperShown = {}; // Track which helpers have been shown

    // Show helper when student struggles with drag-and-drop
    function monitorDragDropStruggle() {
      // Clear any existing timer
      if (helperTimers.dragDrop) {
        clearTimeout(helperTimers.dragDrop);
      }

      // Don't show if already shown or completed
      if (helperShown.dragDrop || learningState.completedActivities.includes('dragDrop')) {
        return;
      }

      helperTimers.dragDrop = setTimeout(() => {
        // Check if student is struggling (less than 2 placements after 30 seconds)
        if (correctPlacements < 2) {
          showContextualHelper('tee',
            "Taking your time? That's smart!",
            "Think about the order: First you say what they claimed, then you bring your proof. Want me to show you?",
            'dragDropHelp'
          );
          helperShown.dragDrop = true;
        }
      }, 30000); // Reduced to 30 seconds for better responsiveness
    }

    // Show helper when student struggles with open response
    function monitorOpenResponseStruggle() {
      // Clear any existing timer
      if (helperTimers.openResponse) {
        clearTimeout(helperTimers.openResponse);
      }

      // Don't show if already shown or completed
      if (helperShown.openResponse || learningState.completedActivities.includes('essay')) {
        return;
      }

      const textarea = document.getElementById('studentResponse');
      if (textarea) {
        helperTimers.openResponse = setTimeout(() => {
          // Check if student hasn't written much after focusing
          if (textarea.value.trim().length < 20) {
            showContextualHelper('lee',
              "Need help getting started?",
              "Remember to start with Step 1: State what they said. I can show you some sentence starters!",
              'openResponseHelp'
            );
            helperShown.openResponse = true;
          }
        }, 20000); // Reduced to 20 seconds
      }
    }

    function showContextualHelper(character, name, message, helpType) {
      const helper = document.getElementById('contextHelper');
      const avatar = document.getElementById('contextHelperAvatar');
      const helperName = document.getElementById('contextHelperName');
      const helperMessage = document.getElementById('contextHelperMessage');

      if (character === 'lee') {
        avatar.src = 'Gemini_Generated_Image_8qgtlc8qgtlc8qgt.png';
        helperName.textContent = 'üìì Lee says:';
      } else {
        avatar.src = 'Gemini_Generated_Image_bvzywpbvzywpbvzy.png';
        helperName.textContent = 'üé§ Tee says:';
      }

      helperMessage.textContent = message;
      helper.dataset.helpType = helpType;
      helper.classList.remove('hidden');
    }

    function showContextHelp() {
      const helpType = document.getElementById('contextHelper').dataset.helpType;

      if (helpType === 'dragDropHelp') {
        openHelper('tee');
      } else if (helpType === 'openResponseHelp') {
        openHelper('lee');
      }

      dismissContextHelper();
    }

    function dismissContextHelper() {
      const helper = document.getElementById('contextHelper');
      helper.classList.add('hidden');

      // Clear timers when dismissed
      Object.keys(helperTimers).forEach(key => {
        if (helperTimers[key]) {
          clearTimeout(helperTimers[key]);
        }
      });
    }

    // Initialize monitoring when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
      // Monitor for drag-and-drop section with IntersectionObserver
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const sectionId = entry.target.id;
            if (sectionId === 'section-4') {
              monitorDragDropStruggle();
            }
          }
        });
      }, {
        threshold: 0.3, // Trigger when 30% of section is visible
        rootMargin: '0px'
      });

      const section4 = document.getElementById('section-4');
      if (section4) observer.observe(section4);

      // Monitor for open response section
      const studentResponse = document.getElementById('studentResponse');
      if (studentResponse) {
        studentResponse.addEventListener('focus', () => {
          monitorOpenResponseStruggle();
        }, { once: false }); // Allow multiple focuses
      }
    });

    // ===== ACCESSIBILITY SETTINGS =====
    function toggleA11yMenu() {
      document.getElementById('a11yMenu').classList.toggle('open');
    }

    function toggleSetting(setting) {
      const toggle = document.getElementById('toggle' + setting.charAt(0).toUpperCase() + setting.slice(1));
      toggle.classList.toggle('on');
      
      if (setting === 'dyslexia') {
        document.body.classList.toggle('dyslexia-mode');
      } else if (setting === 'contrast') {
        document.body.classList.toggle('high-contrast');
      } else if (setting === 'hints') {
        document.querySelectorAll('.hint-text').forEach(el => {
          el.style.display = toggle.classList.contains('on') ? 'block' : 'none';
        });
      }
    }

    // ===== SIOP STRATEGIES =====
    function toggleSiopStrategies() {
      const toggle = document.getElementById('toggleSiop');
      toggle.classList.toggle('on');
      siopStrategiesVisible = toggle.classList.contains('on');
      
      // Show/hide SIOP strategy indicators
      document.querySelectorAll('.siop-strategy').forEach(el => {
        if (siopStrategiesVisible) {
          el.style.display = 'inline-flex';
        } else {
          el.style.display = 'none';
        }
      });
    }

    function toggleSiopModal() {
      document.getElementById('siopModal').classList.toggle('open');
    }

    function closeSiopModal(e) {
      if (e.target.classList.contains('helper-modal')) {
        document.getElementById('siopModal').classList.remove('open');
      }
    }

    // ===== PROGRESS BAR =====
    window.addEventListener('scroll', () => {
      const scrollTop = window.scrollY;
      const docHeight = document.documentElement.scrollHeight - window.innerHeight;
      const progress = (scrollTop / docHeight) * 100;
      const bar = document.getElementById('progressBar');
      if (bar) bar.style.width = progress + '%';

      
      // Award completion badge at end
      if (progress > 95 && !learningState.badges.includes('üèÜ')) {
        awardBadge('üèÜ');
      }
    });

    // ===== VOICE-TO-TEXT FUNCTION =====
    function startDictation(button) {
      if (!('webkitSpeechRecognition' in window)) {
        alert('Voice typing requires Chrome browser. Please use Chrome for this feature.');
        return;
      }
      
      const textarea = button.parentElement.previousElementSibling;
      const recognition = new webkitSpeechRecognition();
      
      recognition.continuous = false;
      recognition.interimResults = false;
      recognition.lang = 'en-US';
      
      recognition.onstart = function() {
        button.textContent = 'üé§ Listening...';
        button.classList.add('bg-red-100', 'text-red-700');
      };
      
      recognition.onresult = function(event) {
        const transcript = event.results[0][0].transcript;
        textarea.value += (textarea.value ? ' ' : '') + transcript;
        
        // Track reflection progress
        if (textarea.value.trim().length > 10) {
          const progressElement = document.getElementById('progress-reflect');
          if (progressElement && !progressElement.classList.contains('completed')) {
            progressElement.textContent = '‚úÖ';
            progressElement.classList.add('completed');
            learningState.completedActivities.push('reflect');
            saveProgress();
            updateProgressPercentage();
          }
        }
      };
      
      recognition.onend = function() {
        button.textContent = 'üé§ Speak Answer';
        button.classList.remove('bg-red-100', 'text-red-700');
      };
      
      recognition.onerror = function(event) {
        console.error('Speech recognition error', event.error);
        button.textContent = 'üé§ Speak Answer';
        button.classList.remove('bg-red-100', 'text-red-700');
      };
      
      recognition.start();
    }

    // ===== BONUS MATCHING ACTIVITY =====
    let matchCount = 0;
    function checkMatch(select, correctValue) {
      if (select.value === correctValue) {
        select.style.background = '#DCFCE7';
        select.style.borderColor = '#16A34A';
        matchCount++;
        if (matchCount >= 4) {
          document.getElementById('matchFeedback').classList.remove('hidden');
          if (!learningState.completedActivities.includes('matching')) {
            learningState.completedActivities.push('matching');
            addPoints(15, 'Perfect match!');
          }
        }
      } else if (select.value !== '') {
        select.style.background = '#FEE2E2';
        select.style.borderColor = '#E11D48';
      }
      saveProgress();
    }

    // ===== SIMPLIFIED TEXT VIEW =====
    function showSimplifiedText(sectionId) {
      const section = document.getElementById(sectionId);
      if (!section) return;
      
      const storyText = section.querySelector('.story-text');
      if (!storyText) return;
      
      // Toggle between original and simplified
      if (storyText.dataset.original) {
        storyText.innerHTML = storyText.dataset.original;
        delete storyText.dataset.original;
      } else {
        // Save original and create simplified version
        storyText.dataset.original = storyText.innerHTML;
        
        // Simple text simplification
        let simplified = storyText.innerHTML
          .replace(/<strong>(.*?)<\/strong>/g, '<strong class="text-purple-700">$1</strong>')
          .replace(/<em>(.*?)<\/em>/g, '<em class="font-bold text-amber-700">$1</em>')
          .replace(/\.\s/g, '.<br><br>')
          .replace(/\,\s/g, ',<br>');
        
        storyText.innerHTML = simplified;
      }
    }
    
    // Auto-mark section progress when scrolling
    const sectionObserver = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const sectionId = entry.target.id;
          let progressId = '';
          
          // Map section IDs to progress IDs
          switch(sectionId) {
            case 'section-1': progressId = 'section1'; break;
            case 'section-2': progressId = 'section2'; break;
            case 'section-3': progressId = 'section3'; break;
            case 'section-aha': progressId = 'drag'; break;
            case 'section-essay': progressId = 'essay'; break;
            default: return;
          }
          
          const progressElement = document.getElementById(`progress-${progressId}`);
          if (progressElement && !progressElement.classList.contains('completed')) {
            progressElement.textContent = '‚úÖ';
            progressElement.classList.add('completed');
            learningState.completedActivities.push(progressId);
            saveProgress();
            updateProgressPercentage();
          }
        }
      });
    }, { threshold: 0.5 });
    
    // Observe sections
    document.addEventListener('DOMContentLoaded', () => {
      ['section-1', 'section-2', 'section-3', 'section-aha', 'section-essay'].forEach(id => {
        const element = document.getElementById(id);
        if (element) sectionObserver.observe(element);
      });

           // Initialize
      loadProgress();

      // Initialize skills visualizer
      if (typeof renderSkillsVisualizer === 'function') {
        renderSkillsVisualizer(1);
      }

      // Initialize progress checklist in left rail
      updateProgressChecklist();

      // Sync unified dashboard shell
      if (window.LearningShell && typeof window.LearningShell.refresh === 'function') {
        window.LearningShell.refresh();
      }

      // Trigger initial learning mode
      if (typeof globalLearningState !== 'undefined') {
        const mode = globalLearningState.learningMode;
        document.dispatchEvent(new CustomEvent('learningModeChanged', { detail: { mode } }));
      }
    });

    // ===== GLOBAL STATE INTEGRATION =====

    // Toggle left rail on mobile
    function toggleLeftRail() {
      const rail = document.getElementById('left-rail');
      if (rail) {
        rail.classList.toggle('mobile-hidden');
        rail.classList.toggle('mobile-open');
      }
    }

    // Reset episode progress
    function resetEpisodeProgress() {
      const message = typeof translator !== 'undefined'
        ? translator.t('messages.reset_global_progress', 'Reset all progress for this episode?')
        : 'Reset all progress for this episode?';
      if (confirm(message)) {
        localStorage.removeItem('leeTeeLessonProgress');
        localStorage.removeItem('episode1SkillState');
        location.reload();
      }
    }

    // Update progress checklist in left rail
    function updateProgressChecklist() {
      const checklist = document.getElementById('progress-checklist');
      if (!checklist) return;

      const t = (key, fallback) => (typeof translator !== 'undefined' ? translator.t(key, fallback) : fallback);

      const items = [
        { id: 'progress-sel', key: 'progress_labels.sel', fallback: 'Check-In' },
        { id: 'progress-vocab', key: 'progress_labels.vocab', fallback: 'Vocabulary' },
        { id: 'progress-section1', key: 'progress_labels.section1', fallback: 'Section 1' },
        { id: 'progress-section2', key: 'progress_labels.section2', fallback: 'Section 2' },
        { id: 'progress-section3', key: 'progress_labels.section3', fallback: 'Section 3' },
        { id: 'progress-drag', key: 'progress_labels.drag', fallback: 'Drag & Drop' },
        { id: 'progress-essay', key: 'progress_labels.essay', fallback: 'Model Essay' },
        { id: 'progress-reflect', key: 'progress_labels.reflect', fallback: 'Reflection' }
      ];

      checklist.innerHTML = items.map(item => {
        const el = document.getElementById(item.id);
        const complete = el && el.classList.contains('completed');
        const label = t(item.key, item.fallback);
        return `
          <div class="flex items-center gap-2 px-3 py-2 rounded-lg ${complete ? 'bg-green-50' : 'bg-gray-50'}">
            <span class="text-lg">${complete ? '‚úÖ' : '‚¨ú'}</span>
            <span class="text-gray-700 ${complete ? 'font-semibold' : ''}">${label}</span>
          </div>
        `;
      }).join('');
    }

    // Hook into vocab learning for skills tracking
    const originalShowVocab = typeof showVocab !== 'undefined' ? showVocab : null;
    if (originalShowVocab) {
      window.showVocab = function(word) {
        originalShowVocab(word);
        if (typeof onVocabLearned === 'function') {
          onVocabLearned(1, word);
        }
      };
    }

    // Listen for learning mode changes to update help content
    document.addEventListener('learningModeChanged', (e) => {
      // Update help boxes if they exist
      // (Episode 1 uses helper buttons, future episodes will use help boxes)
    });

    // ========================================
    // OPTION 3: PROGRESSIVE NAV INITIALIZATION
    // ========================================

    // Initialize progressive navigation system
    let progressiveNav;

    document.addEventListener('DOMContentLoaded', async () => {
      try {
        console.log('üöÄ Initializing Option 3: Progressive Navigation & Translation');

        // 1. Initialize ProgressiveNav
        progressiveNav = new ProgressiveNav(1, 7); // Episode 1, 7 sections total

        // 2. Register all sections
        progressiveNav.registerSection(1, 'Start & Check-In', 'üèÅ', false);
        progressiveNav.registerSection(2, 'Vocabulary', 'üìö', false);
        progressiveNav.registerSection(3, 'The Story', 'üìñ', false);
        progressiveNav.registerSection(4, "Tee's 4-Step Strategy", 'üß≠', false);
        progressiveNav.registerSection(5, "Lee's Essay Model", '‚úçÔ∏è', false);
        progressiveNav.registerSection(6, 'Your Turn to Write', 'üìù', false);
        progressiveNav.registerSection(7, 'Reflect & Celebrate', 'üí≠', false);

        // 3. Wrap existing content sections into progressive nav containers
        wrapSectionsForProgressiveNav();

        // Debug: Check what got wrapped
        console.log('DEBUG: Checking wrapped sections...');
        const sectionDisplay = document.getElementById('section-display');
        if (sectionDisplay) {
          const wrappedSections = sectionDisplay.querySelectorAll('.section-content');
          console.log(`Found ${wrappedSections.length} .section-content elements`);
          wrappedSections.forEach(section => {
            console.log(`  - Section ${section.getAttribute('data-section')}`);
          });
        } else {
          console.error('section-display container not found!');
        }

        // 4. Initialize the navigation
        progressiveNav.init();

        // FORCE Section 1 to show (ignore saved state for now)
        setTimeout(() => {
          progressiveNav.currentSection = 1;
          progressiveNav.showSection(1);
          console.log('‚úì Forced Section 1 to display');
        }, 100);

        // 5. Load translation languages
        await translator.loadLanguage('en');
        await translator.loadLanguage('es');
        await translator.loadLanguage('fr');
        await translator.loadLanguage('ht');

        // 6. Initialize adaptive helpers
        adaptiveHelpers.init();

        // 7. Add translation UI toggle
        addTranslationUI();
        translator.translatePage();
        translator.renderStoryLanguage(translator.currentLang);

        // 8. Connect character choice to adaptive system
        connectCharacterChoice();

        console.log('‚úÖ Option 3 initialized successfully');

      } catch (error) {
        console.error('‚ùå Failed to initialize Option 3:', error);
        // Graceful degradation - show all content if system fails
        document.querySelectorAll('.section-content').forEach(section => {
          section.style.display = 'block';
        });
      }
    });

    /**
     * Wrap existing sections into progressive nav containers
     */
    function wrapSectionsForProgressiveNav() {
      // Find the section-display container
      let sectionDisplay = document.getElementById('section-display');

      // If it doesn't exist, create it
      if (!sectionDisplay) {
        sectionDisplay = document.createElement('div');
        sectionDisplay.id = 'section-display';
        sectionDisplay.className = 'section-display';

        // Find where to insert it (after learning objectives)
        const learningObjectives = document.querySelector('.bg-white.border-b');
        if (learningObjectives && learningObjectives.parentNode) {
          learningObjectives.parentNode.insertBefore(sectionDisplay, learningObjectives.nextSibling);
        }
      }

      // Section 1: SEL Check-In + Character Choice
      const selSection = document.getElementById('sel-checkin');
      const characterSection = document.getElementById('character-choice');

      if (selSection && characterSection) {
        const section1 = document.createElement('div');
        section1.className = 'section-content';
        section1.setAttribute('data-section', '1');

        // Move SEL and Character sections into Section 1
        sectionDisplay.appendChild(section1);
        section1.appendChild(selSection);
        section1.appendChild(characterSection);

        console.log('‚úì Section 1 wrapped (SEL + Character Choice)');
      } else {
        console.warn('Could not find SEL or Character sections');
      }

      // Section 2: Vocabulary
      const vocabSection = document.getElementById('section-vocab');
      if (vocabSection) {
        const section2 = document.createElement('div');
        section2.className = 'section-content';
        section2.setAttribute('data-section', '2');
        sectionDisplay.appendChild(section2);
        section2.appendChild(vocabSection);

        console.log('‚úì Section 2 wrapped (Vocabulary)');
      } else {
        console.warn('Could not find Vocabulary section');
      }

      // Section 3: The Story - wrap all story sections together
      const storyAnchor = document.getElementById('the-story-begins');
      const firstStorySection = storyAnchor ? storyAnchor.nextElementSibling : null;

      if (firstStorySection) {
        const section3 = document.createElement('div');
        section3.className = 'section-content';
        section3.setAttribute('data-section', '3');
        sectionDisplay.appendChild(section3);

        // Move all story sections (until we hit the 4-step strategy anchor)
        let currentElement = firstStorySection;
        const strategyAnchor = document.getElementById('tees-4-step-strategy');

        while (currentElement && currentElement !== strategyAnchor) {
          const nextElement = currentElement.nextElementSibling;
          if (currentElement.tagName === 'SECTION' || currentElement.classList.contains('story-section')) {
            section3.appendChild(currentElement);
          }
          currentElement = nextElement;
        }

        console.log('‚úì Section 3 wrapped (The Story)');
      }

      // Section 4: Tee's 4-Step Strategy
      const strategyAnchor = document.getElementById('tees-4-step-strategy');
      const strategySection = strategyAnchor ? strategyAnchor.nextElementSibling : null;

      if (strategySection) {
        const section4 = document.createElement('div');
        section4.className = 'section-content';
        section4.setAttribute('data-section', '4');
        sectionDisplay.appendChild(section4);

        // Move content until Lee's essay anchor
        let currentElement = strategyAnchor;
        const essayAnchor = document.getElementById('lees-essay-model');

        while (currentElement && currentElement !== essayAnchor) {
          const nextElement = currentElement.nextElementSibling;
          section4.appendChild(currentElement);
          currentElement = nextElement;
        }

        console.log('‚úì Section 4 wrapped (4-Step Strategy)');
      }

      // Section 5: Lee's Essay Model
      const essayAnchor = document.getElementById('lees-essay-model');
      const essaySection = document.getElementById('section-essay');

      if (essayAnchor && essaySection) {
        const section5 = document.createElement('div');
        section5.className = 'section-content';
        section5.setAttribute('data-section', '5');
        sectionDisplay.appendChild(section5);

        // Move content until Your Turn anchor
        let currentElement = essayAnchor;
        const writeAnchor = document.getElementById('your-turn-write');

        while (currentElement && currentElement !== writeAnchor) {
          const nextElement = currentElement.nextElementSibling;
          section5.appendChild(currentElement);
          currentElement = nextElement;
        }

        console.log('‚úì Section 5 wrapped (Essay Model)');
      }

      // Section 6: Your Turn to Write
      const writeAnchor = document.getElementById('your-turn-write');

      if (writeAnchor) {
        const section6 = document.createElement('div');
        section6.className = 'section-content';
        section6.setAttribute('data-section', '6');
        sectionDisplay.appendChild(section6);

        // Move content until Reflect anchor
        let currentElement = writeAnchor;
        const reflectAnchor = document.getElementById('reflect-on-your-learning');

        while (currentElement && currentElement !== reflectAnchor) {
          const nextElement = currentElement.nextElementSibling;
          section6.appendChild(currentElement);
          currentElement = nextElement;
        }

        console.log('‚úì Section 6 wrapped (Your Turn to Write)');
      }

      // Section 7: Reflect & Celebrate
      const reflectAnchor = document.getElementById('reflect-on-your-learning');
      const reflectSection = document.getElementById('section-reflect');

      if (reflectAnchor && reflectSection) {
        const section7 = document.createElement('div');
        section7.className = 'section-content';
        section7.setAttribute('data-section', '7');
        sectionDisplay.appendChild(section7);

        // Move the anchor
        section7.appendChild(reflectAnchor);

        // Move all content sections until we hit the closing wrapper div or scripts
        let currentElement = reflectSection;
        while (currentElement) {
          const nextElement = currentElement.nextElementSibling;

          // Stop if we hit a script tag
          if (currentElement.tagName === 'SCRIPT') {
            break;
          }

          // Stop if we hit the closing wrapper div (has comment "Close px wrapper")
          if (currentElement.nodeType === 8 || // Comment node
              (currentElement.tagName === 'DIV' && !currentElement.id && !currentElement.className)) {
            break;
          }

          // Move section elements (reflection, lesson complete, skills visualizer)
          if (currentElement.tagName === 'SECTION' || currentElement.id === 'skills-visualizer') {
            section7.appendChild(currentElement);
          }

          currentElement = nextElement;
        }

        console.log('‚úì Section 7 wrapped (Reflect & Celebrate)');
      }

      console.log(`Total sections wrapped: ${sectionDisplay.children.length} of 7`);
    }

    /**
     * Add translation UI toggle
     */
    function addTranslationUI() {
      const stickyContainer = document.getElementById('sticky-ui');
      if (!stickyContainer) return;

      const langToggle = document.createElement('div');
      langToggle.className = 'language-toggle';
      langToggle.innerHTML = `
        <label for="lang-select" data-i18n="ui.language_label">Language:</label>
        <select id="lang-select">
          <option value="en">English</option>
          <option value="es">Espa√±ol</option>
          <option value="fr">Fran√ßais</option>
          <option value="ht">Krey√≤l</option>
        </select>
      `;

      stickyContainer.appendChild(langToggle);

      const storedLang = localStorage.getItem('preferred-language') || 'en';
      const selectEl = document.getElementById('lang-select');
      selectEl.value = storedLang;

      selectEl.addEventListener('change', async (e) => {
        await translator.applyLanguage(e.target.value);
        updateProgressChecklist();
      });
    }

    /**
     * Connect character choice to adaptive helpers
     */
    function connectCharacterChoice() {
      // Override existing chooseCharacter function to integrate with adaptive system
      const originalChooseCharacter = window.chooseCharacter;

      window.chooseCharacter = function(character) {
        // Call original function if it exists
        if (typeof originalChooseCharacter === 'function') {
          originalChooseCharacter(character);
        }

        // Set character choice in adaptive helpers
        adaptiveHelpers.setCharacterChoice(character);

        // Show feedback
        const feedback = document.getElementById('characterFeedback');
        if (feedback) {
          feedback.classList.remove('hidden');

          const leeTitle = typeof translator !== 'undefined'
            ? translator.t('character_feedback.lee_title', 'Great choice! You chose Lee!')
            : 'Great choice! You chose Lee!';
          const leeBody = typeof translator !== 'undefined'
            ? translator.t('character_feedback.lee_body', "You'll see more sentence frames, word banks, and step-by-step scaffolds throughout the lesson.")
            : "You'll see more sentence frames, word banks, and step-by-step scaffolds throughout the lesson.";
          const teeTitle = typeof translator !== 'undefined'
            ? translator.t('character_feedback.tee_title', 'Great choice! You chose Tee!')
            : 'Great choice! You chose Tee!';
          const teeBody = typeof translator !== 'undefined'
            ? translator.t('character_feedback.tee_body', "You'll see strategic thinking questions and problem-solving prompts throughout the lesson.")
            : "You'll see strategic thinking questions and problem-solving prompts throughout the lesson.";

          if (character === 'lee') {
            feedback.innerHTML = `
              <p class="font-bold text-purple-800 mb-2">${leeTitle}</p>
              <p class="text-sm">${leeBody}</p>
            `;
          } else {
            feedback.innerHTML = `
              <p class="font-bold text-amber-800 mb-2">${teeTitle}</p>
              <p class="text-sm">${teeBody}</p>
            `;
          }
        }

        // Log the choice
        console.log(`‚úì Student chose ${character} - adaptive scaffolding activated`);
      };
    }

    document.addEventListener('languageChanged', () => {
      updateProgressChecklist();
      const feedback = document.getElementById('characterFeedback');
      if (feedback && typeof state !== 'undefined' && state.guideChoice) {
        const isLee = state.guideChoice === 'lee';
        const title = typeof translator !== 'undefined'
          ? translator.t(isLee ? 'character_feedback.lee_title' : 'character_feedback.tee_title', isLee ? 'Great choice! You chose Lee!' : 'Great choice! You chose Tee!')
          : isLee ? 'Great choice! You chose Lee!' : 'Great choice! You chose Tee!';
        const body = typeof translator !== 'undefined'
          ? translator.t(isLee ? 'character_feedback.lee_body' : 'character_feedback.tee_body', isLee
            ? "You'll see more sentence frames, word banks, and step-by-step scaffolds throughout the lesson."
            : "You'll see strategic thinking questions and problem-solving prompts throughout the lesson.")
          : isLee
            ? "You'll see more sentence frames, word banks, and step-by-step scaffolds throughout the lesson."
            : "You'll see strategic thinking questions and problem-solving prompts throughout the lesson.";

        feedback.classList.remove('hidden');
        feedback.innerHTML = `
          <p class="font-bold ${isLee ? 'text-purple-800' : 'text-amber-800'} mb-2">${title}</p>
          <p class="text-sm">${body}</p>
        `;
      }
    });

    /**
     * Navigation controls
     */
    function nextSection() {
      if (progressiveNav) {
        progressiveNav.nextSection();
      }
    }

    function previousSection() {
      if (progressiveNav) {
        progressiveNav.previousSection();
      }
    }
</script>
</body>
</html>


















